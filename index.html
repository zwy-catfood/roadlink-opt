<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>路口通 (RoadLink Opt) - 人车协同路口优化SaaS平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
    <!-- 使用高德地图API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=585111c07057922154b50b728f531ee6"></script>
    <script src="https://webapi.amap.com/ui/1.1/main.js?v=1.1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
        font-family: 'Inter', 'HarmonyOS Sans', sans-serif;
        background-color: #f8fafc;
        }
        .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .sidebar-item-active {
        background-color: #eff6ff;
        color: #1d4ed8;
        border-right: 4px solid #1d4ed8;
        }
        .chart-container {
        min-height: 400px;
        width: 100%;
        }
        .phase-bar {
        transition: all 0.3s ease;
        }
        .phase-bar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
        }
        ::-webkit-scrollbar-track {
        background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
        }
        .input-group {
        transition: all 0.2s;
        }
        .input-group:focus-within {
        transform: translateX(4px);
        }
        .stat-card {
        min-width: 0;
        overflow: hidden;
        }
        .stat-value {
        word-break: break-all;
        font-size: 2.25rem;
        line-height: 1;
        }
        @media (max-width: 1280px) {
        .stat-value {
        font-size: 1.875rem;
        }
        }
        .map-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 200;
        display: none;
        align-items: center;
        justify-content: center;
        }
        .map-modal.active {
        display: flex;
        }
        .project-modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 150;
        display: none;
        align-items: center;
        justify-content: center;
        }
        .project-modal.active {
        display: flex;
        }
        .map-container {
        width: 80%;
        height: 80%;
        background: white;
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        }
        #map-container {
        flex: 1;
        width: 100%;
        height: 100%;
        }
        #radar-chart, #bar-chart, #sensitivity-3d-chart, #phase-bar-chart {
        width: 100%;
        height: 100%;
        min-height: 300px;
        }
        .intersection-phase-img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        }
        .selected-location-box {
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 8px;
        padding: 12px;
        margin-top: 8px;
        }
        .selected-location-box .coord {
        font-family: monospace;
        color: #0369a1;
        font-size: 12px;
        }
        .selected-location-box .address {
        color: #0f172a;
        font-size: 13px;
        margin-top: 4px;
        font-weight: 500;
        }
        .auth-tab {
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 2px solid transparent;
        }
        .auth-tab.active {
        color: #1d4ed8;
        border-bottom-color: #1d4ed8;
        }
        .auth-tab:hover:not(.active) {
        color: #64748b;
        }
        .auth-form {
        display: none;
        }
        .auth-form.active {
        display: block;
        }
    </style>
</head>
<body class="text-slate-800">

<!-- 地图选择弹窗 -->
<div class="map-modal" id="map-modal">
    <div class="map-container">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between bg-white">
            <div>
                <h3 class="font-bold text-lg text-slate-800">选择路口位置</h3>
                <p class="text-sm text-slate-500">在地图上点击选择位置，或搜索地址</p>
            </div>
            <div class="flex items-center gap-3">
                <input type="text" id="map-search-input" placeholder="搜索路口地址..." class="px-4 py-2 border border-slate-200 rounded-lg text-sm w-64">
                <button onclick="searchMapLocation()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">搜索</button>
                <button onclick="closeMapModal()" class="px-4 py-2 border border-slate-300 text-slate-600 rounded-lg text-sm hover:bg-slate-50">取消</button>
                <button onclick="confirmMapLocation()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700">确认选择</button>
            </div>
        </div>
        <div id="map-container"></div>
        <div class="p-4 bg-slate-50 border-t border-slate-200" id="selected-location-info">
            <div class="text-sm text-slate-500 mb-2">未选择位置</div>
        </div>
    </div>
</div>

<!-- 新建项目弹窗 -->
<div class="project-modal" id="project-modal">
    <div class="bg-white rounded-2xl p-8 w-[500px] max-w-[90%] shadow-2xl">
        <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
            <span class="iconify mr-2 text-blue-600" data-icon="mdi:plus-circle"></span>
            新建分析项目
        </h3>
        <div class="space-y-4 mb-6">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">项目名称 <span class="text-red-500">*</span></label>
                <input type="text" id="new-project-name" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如：长安大街与建国路路口">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">路口类型</label>
                <select id="new-project-type" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                    <option value="右转口袋车道">右转口袋车道</option>
                    <option value="标准十字路口">标准十字路口</option>
                    <option value="T型路口">T型路口</option>
                    <option value="环岛路口">环岛路口</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">地理位置</label>
                <div class="flex gap-2">
                    <input type="text" id="new-project-location" readonly class="flex-1 px-4 py-3 rounded-lg border border-slate-200 bg-slate-50 text-slate-600" placeholder="点击右侧按钮选择地图位置">
                    <button onclick="openMapForProject()" class="px-4 py-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors flex items-center">
                        <span class="iconify mr-1" data-icon="mdi:map-marker"></span>
                        选点
                    </button>
                </div>
                <div id="selected-address-display" class="mt-2 text-xs text-slate-500 hidden">
                    <span class="font-medium">已选位置：</span><span id="address-text"></span>
                </div>
                <input type="hidden" id="new-project-lat">
                <input type="hidden" id="new-project-lng">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">项目描述（可选）</label>
                <textarea id="new-project-desc" rows="3" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="描述该路口的特殊情况或分析目标..."></textarea>
            </div>
        </div>
        <div class="flex justify-end gap-3">
            <button onclick="closeProjectModal()" class="px-6 py-3 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 transition-colors">取消</button>
            <button onclick="createNewProject()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">创建并配置参数</button>
        </div>
    </div>
</div>

<div class="min-h-screen flex overflow-hidden" id="app">
    <!-- 登录/注册页面 -->
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 overflow-hidden" id="page-login">
        <div class="absolute inset-0 opacity-20">
            <div class="absolute inset-0 bg-gradient-to-br from-blue-900/40 to-slate-900/60"></div>
            <svg class="w-full h-full" viewBox="0 0 1200 600" preserveAspectRatio="xMidYMid slice">
                <defs>
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />
                <line x1="200" y1="0" x2="200" y2="600" stroke="rgba(59,130,246,0.3)" stroke-width="60" />
                <line x1="0" y1="300" x2="1200" y2="300" stroke="rgba(59,130,246,0.3)" stroke-width="60" />
                <line x1="800" y1="0" x2="800" y2="600" stroke="rgba(59,130,246,0.2)" stroke-width="40" />
                <line x1="0" y1="150" x2="1200" y2="150" stroke="rgba(59,130,246,0.2)" stroke-width="40" />
            </svg>
        </div>
        <div class="w-full max-w-md p-8 glass-card rounded-2xl shadow-2xl relative z-10">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-xl mb-4 text-white shadow-lg shadow-blue-500/30">
                    <span class="iconify" data-icon="mdi:road-variant" data-width="40"></span>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 italic">路口通 <span class="text-blue-600 font-normal not-italic text-sm ml-1 uppercase tracking-widest">RoadLink Opt</span></h1>
                <p class="text-slate-500 mt-2">基于人车协同模型的路口通行优化SaaS平台</p>
                <div class="mt-4 inline-flex items-center px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-medium">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></span>
                    计算引擎 V2.1
                </div>
            </div>

            <!-- 登录/注册切换标签 -->
            <div class="flex justify-center mb-6 border-b border-slate-200">
                <div class="auth-tab active px-6 py-3 font-medium text-sm" onclick="switchAuthTab('login')">账号登录</div>
                <div class="auth-tab px-6 py-3 font-medium text-sm text-slate-500" onclick="switchAuthTab('register')">注册账号</div>
            </div>

            <!-- 登录表单 -->
            <form class="auth-form active space-y-5" id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">账号</label>
                    <input id="login-username" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="请输入账号" type="text">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">密码</label>
                    <input id="login-password" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="请输入密码" type="password">
                </div>
                <div class="flex items-center justify-between text-sm">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input checked="" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500" type="checkbox">
                        <span class="text-slate-600">记住当前设备</span>
                    </label>
                    <a class="text-blue-600 hover:underline" href="#">忘记密码?</a>
                </div>
                <button class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center space-x-2" type="submit">
                    <span>登录</span>
                    <span class="iconify" data-icon="mdi:arrow-right" data-width="18"></span>
                </button>
            </form>

            <!-- 注册表单 -->
            <form class="auth-form space-y-4" id="register-form" onsubmit="event.preventDefault(); handleRegister();">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">账号名称 <span class="text-red-500">*</span></label>
                    <input id="reg-username" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="设置登录账号" type="text">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">设置密码 <span class="text-red-500">*</span></label>
                    <input id="reg-password" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="设置登录密码" type="password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">确认密码 <span class="text-red-500">*</span></label>
                    <input id="reg-password-confirm" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="再次输入密码" type="password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">手机号码 <span class="text-red-500">*</span></label>
                    <div class="flex gap-2">
                        <input id="reg-phone" class="flex-1 px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="请输入手机号" type="tel">
                        <button type="button" onclick="sendVerifyCode()" class="px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium transition-colors whitespace-nowrap" id="send-code-btn">
                            获取验证码
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">验证码 <span class="text-red-500">*</span></label>
                    <input id="reg-code" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="请输入短信验证码" type="text">
                </div>
                <button class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-lg shadow-green-500/30 transition-all flex items-center justify-center space-x-2" type="submit">
                    <span>注册账号</span>
                    <span class="iconify" data-icon="mdi:account-plus" data-width="18"></span>
                </button>
            </form>

            <div class="text-center mt-6">
                <p class="text-sm text-slate-400">当前计算引擎版本：V2.1.0 (2026-02-27)</p>
            </div>
        </div>
    </div>

    <!-- 主页面结构 -->
    <div class="hidden flex w-full h-screen" id="main-structure">
        <!-- 侧边导航栏 -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0">
            <div class="p-6">
                <div class="flex items-center space-x-2">
                    <span class="iconify text-blue-600" data-icon="mdi:road-variant" data-width="28"></span>
                    <span class="text-xl font-bold text-slate-800 tracking-tight italic">路口通</span>
                </div>
            </div>
            <nav class="flex-1 space-y-1">
                <a class="sidebar-item-active flex items-center px-6 py-3 space-x-3 transition-colors" href="javascript:void(0)" id="nav-dashboard" onclick="navigateTo('page-dashboard')">
                    <span class="iconify" data-icon="mdi:view-dashboard-outline"></span>
                    <span class="font-medium">项目控制台</span>
                </a>
                <a class="flex items-center px-6 py-3 space-x-3 text-slate-600 hover:bg-slate-50 transition-colors" href="javascript:void(0)" id="nav-config" onclick="navigateTo('page-config')">
                    <span class="iconify" data-icon="mdi:tune-vertical"></span>
                    <span class="font-medium">参数配置</span>
                </a>
                <a class="flex items-center px-6 py-3 space-x-3 text-slate-600 hover:bg-slate-50 transition-colors" href="javascript:void(0)" id="nav-analysis" onclick="navigateTo('page-analysis')">
                    <span class="iconify" data-icon="mdi:chart-scatter-plot"></span>
                    <span class="font-medium">通行能力分析</span>
                </a>
                <a class="flex items-center px-6 py-3 space-x-3 text-slate-600 hover:bg-slate-50 transition-colors" href="javascript:void(0)" id="nav-sensitivity" onclick="navigateTo('page-sensitivity')">
                    <span class="iconify" data-icon="mdi:chart-bubble"></span>
                    <span class="font-medium">敏感度分析</span>
                </a>
                <a class="flex items-center px-6 py-3 space-x-3 text-slate-600 hover:bg-slate-50 transition-colors" href="javascript:void(0)" id="nav-optimize" onclick="navigateTo('page-optimize')">
                    <span class="iconify" data-icon="mdi:lightbulb-on-outline"></span>
                    <span class="font-medium">优化建议</span>
                </a>
                <div class="px-6 py-4 mt-10">
                    <div class="text-xs uppercase tracking-widest text-slate-400 font-bold mb-4">工具服务</div>
                    <a class="flex items-center py-2 space-x-3 text-slate-600 hover:text-blue-600 cursor-pointer" onclick="exportReport()">
                        <span class="iconify" data-icon="mdi:file-pdf-box"></span>
                        <span>导出报告</span>
                    </a>
                    <a class="flex items-center py-2 space-x-3 text-slate-600 hover:text-blue-600 cursor-pointer" onclick="showHistoryComparison()">
                        <span class="iconify" data-icon="mdi:history"></span>
                        <span>历史对比</span>
                    </a>
                </div>
            </nav>
            <div class="p-6 border-t border-slate-100 italic font-mono text-xs text-slate-400">
                RoadLink v2.1.0 Build 2026.02<br>
                Gamma-Poisson Engine
            </div>
        </aside>

        <!-- 右侧主内容 -->
        <main class="flex-1 flex flex-col h-full bg-slate-50 overflow-y-auto relative">
            <!-- 顶部栏 -->
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-10">
                <div class="flex items-center space-x-4">
                    <div class="text-lg font-semibold text-slate-800" id="page-title">项目仪表盘</div>
                    <div class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-medium border border-blue-100" id="current-project-badge" style="display: none;">
                        当前项目: <span id="current-project-name">--</span>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-2 text-sm text-slate-500">
                        <span class="iconify" data-icon="mdi:calendar-clock"></span>
                        <span id="current-date">2026年02月27日</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-sm">陈</div>
                        <span class="text-sm font-medium text-slate-700">陈工</span>
                        <span class="iconify text-slate-400" data-icon="mdi:chevron-down"></span>
                    </div>
                </div>
            </header>

            <!-- 内容页面区域 -->
            <div class="p-8">
                <!-- 页面: 仪表盘 -->
                <div class="page-content space-y-6" id="page-dashboard-content">
                    <div class="grid grid-cols-4 gap-6">
                        <div class="glass-card p-6 rounded-xl stat-card">
                            <p class="text-sm text-slate-500 mb-1">总分析次数</p>
                            <div class="flex items-baseline space-x-2">
                                <span class="text-3xl font-bold stat-value" id="stat-total-analysis">50</span>
                                <span class="text-green-500 text-xs font-medium" id="stat-analysis-change">↑ 0%</span>
                            </div>
                        </div>
                        <div class="glass-card p-6 rounded-xl stat-card">
                            <p class="text-sm text-slate-500 mb-1">当前活跃项目</p>
                            <div class="flex items-baseline space-x-2">
                                <span class="text-3xl font-bold stat-value" id="stat-active-projects">3</span>
                                <span class="text-blue-500 text-xs font-medium" id="stat-projects-change">本月新增0</span>
                            </div>
                        </div>
                        <div class="glass-card p-6 rounded-xl stat-card">
                            <p class="text-sm text-slate-500 mb-1">平均通行能力提升</p>
                            <div class="flex items-baseline space-x-2">
                                <span class="text-3xl font-bold stat-value" id="stat-avg-improvement">18.5%</span>
                                <span class="text-green-500 text-xs font-medium">优化显著</span>
                            </div>
                        </div>
                        <div class="glass-card p-6 rounded-xl stat-card">
                            <p class="text-sm text-slate-500 mb-1">模型置信度</p>
                            <div class="flex items-baseline space-x-2">
                                <span class="text-3xl font-bold text-blue-600 stat-value">96.8%</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl p-6">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                            <span class="iconify mr-2 text-blue-500" data-icon="mdi:lightning-bolt"></span>
                            快速开始
                        </h3>
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="openProjectModal()" class="p-4 border-2 border-dashed border-blue-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all text-left group">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mb-3 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                    <span class="iconify" data-icon="mdi:calculator" data-width="20"></span>
                                </div>
                                <h4 class="font-semibold text-slate-800 mb-1">新建分析</h4>
                                <p class="text-xs text-slate-500">配置路口参数并计算通行能力</p>
                            </button>
                            <button onclick="navigateTo('page-sensitivity')" class="p-4 border-2 border-dashed border-purple-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all text-left group">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600 mb-3 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                    <span class="iconify" data-icon="mdi:chart-areaspline" data-width="20"></span>
                                </div>
                                <h4 class="font-semibold text-slate-800 mb-1">敏感度分析</h4>
                                <p class="text-xs text-slate-500">查看三维参数影响曲面</p>
                            </button>
                            <button onclick="navigateTo('page-optimize')" class="p-4 border-2 border-dashed border-amber-200 rounded-xl hover:border-amber-500 hover:bg-amber-50 transition-all text-left group">
                                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600 mb-3 group-hover:bg-amber-600 group-hover:text-white transition-colors">
                                    <span class="iconify" data-icon="mdi:auto-fix" data-width="20"></span>
                                </div>
                                <h4 class="font-semibold text-slate-800 mb-1">智能优化</h4>
                                <p class="text-xs text-slate-500">获取路口优化建议方案</p>
                            </button>
                        </div>
                    </div>

                    <div class="glass-card rounded-xl overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-bold text-slate-800">最近活跃项目</h3>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors flex items-center" onclick="openProjectModal()">
                                <span class="iconify mr-2" data-icon="mdi:plus"></span>新项目分析
                            </button>
                        </div>
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                            <tr>
                                <th class="px-6 py-4">项目名称</th>
                                <th class="px-6 py-4">路口类型</th>
                                <th class="px-6 py-4">地理位置</th>
                                <th class="px-6 py-4">最后修改时间</th>
                                <th class="px-6 py-4">通行能力 (veh/h)</th>
                                <th class="px-6 py-4">状态</th>
                                <th class="px-6 py-4">操作</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-sm" id="project-table-body">
                            <!-- 动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 页面: 参数配置 -->
                <div class="page-content hidden" id="page-config-content">
                    <div class="flex gap-8">
                        <div class="flex-1 space-y-6">
                            <div class="glass-card rounded-xl p-4 bg-blue-50 border border-blue-200" id="project-info-banner" style="display: none;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-bold text-blue-900" id="config-project-name">--</h4>
                                        <p class="text-sm text-blue-700" id="config-project-location">--</p>
                                    </div>
                                    <button onclick="saveProjectConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                                        保存到项目
                                    </button>
                                </div>
                            </div>
                            <section class="glass-card rounded-xl overflow-hidden shadow-sm">
                                <div class="bg-slate-50 px-6 py-3 border-b border-slate-100 flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="w-6 h-6 flex items-center justify-center bg-blue-100 text-blue-600 rounded-md text-xs font-bold">01</span>
                                        <h4 class="font-bold text-slate-700">物理与信号控制参数</h4>
                                    </div>
                                </div>
                                <div class="p-6 grid grid-cols-2 gap-6">
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">口袋车道容量 n (辆)</label>
                                        <input id="param-n" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none transition-colors" type="number" value="10" min="3" max="20">
                                        <p class="text-[10px] text-slate-400 mt-1">右转专用车道可容纳的最大车辆数</p>
                                    </div>
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">信号周期时长 C (秒)</label>
                                        <input id="param-C" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none transition-colors" type="number" value="120" min="60" max="300">
                                        <p class="text-[10px] text-slate-400 mt-1">完整信号周期总时长</p>
                                    </div>
                                </div>
                            </section>
                            <section class="glass-card rounded-xl overflow-hidden shadow-sm border-2 border-blue-100">
                                <div class="bg-blue-50 px-6 py-3 border-b border-blue-100 flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="w-6 h-6 flex items-center justify-center bg-blue-600 text-white rounded-md text-xs font-bold">02</span>
                                        <h4 class="font-bold text-slate-800">四相位切换时刻配置</h4>
                                    </div>
                                    <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded font-medium">核心参数</span>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-3 gap-4 mb-4">
                                        <div class="input-group">
                                            <label class="block text-xs font-bold text-blue-600 uppercase mb-2">t_a: A→B切换 (秒)</label>
                                            <input id="param-ta" class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:border-blue-500 outline-none bg-blue-50/30" type="number" value="30" min="0">
                                            <p class="text-[10px] text-slate-500 mt-1">南北直行→南北左转</p>
                                        </div>
                                        <div class="input-group">
                                            <label class="block text-xs font-bold text-blue-600 uppercase mb-2">t_b: B→C切换 (秒)</label>
                                            <input id="param-tb" class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:border-blue-500 outline-none bg-blue-50/30" type="number" value="60" min="0">
                                            <p class="text-[10px] text-slate-500 mt-1">南北左转→东西直行</p>
                                        </div>
                                        <div class="input-group">
                                            <label class="block text-xs font-bold text-blue-600 uppercase mb-2">t_c: C→D切换 (秒)</label>
                                            <input id="param-tc" class="w-full px-4 py-2 rounded-lg border border-blue-200 focus:border-blue-500 outline-none bg-blue-50/30" type="number" value="90" min="0">
                                            <p class="text-[10px] text-slate-500 mt-1">东西直行→东西左转</p>
                                        </div>
                                    </div>
                                    <div class="mt-4 bg-slate-100 rounded-lg p-4">
                                        <div class="flex justify-between text-xs text-slate-500 mb-2">
                                            <span>0s</span>
                                            <span id="phase-ta-label">30s</span>
                                            <span id="phase-tb-label">60s</span>
                                            <span id="phase-tc-label">90s</span>
                                            <span id="phase-C-label">120s</span>
                                        </div>
                                        <div class="h-12 w-full flex rounded-lg overflow-hidden shadow-inner relative" id="phase-visual-bar">
                                            <div class="phase-bar flex-1 bg-blue-500 flex flex-col items-center justify-center text-white text-xs font-bold relative group" style="flex: 1;">
                                                <span>相位A</span>
                                                <span class="text-[10px] opacity-75">南北直行绿</span>
                                            </div>
                                            <div class="phase-bar flex-1 bg-red-500 flex flex-col items-center justify-center text-white text-xs font-bold relative group" style="flex: 1;">
                                                <span>相位B</span>
                                                <span class="text-[10px] opacity-75">南北左转绿</span>
                                            </div>
                                            <div class="phase-bar flex-1 bg-amber-500 flex flex-col items-center justify-center text-white text-xs font-bold relative group" style="flex: 1;">
                                                <span>相位C</span>
                                                <span class="text-[10px] opacity-75">东西直行绿</span>
                                            </div>
                                            <div class="phase-bar flex-1 bg-emerald-500 flex flex-col items-center justify-center text-white text-xs font-bold relative group" style="flex: 1;">
                                                <span>相位D</span>
                                                <span class="text-[10px] opacity-75">东西左转绿</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between mt-2 text-[10px] text-slate-400">
                                            <span class="text-blue-600 font-medium">A: 南北直行</span>
                                            <span class="text-red-600 font-medium">B: 南北左转</span>
                                            <span class="text-amber-600 font-medium">C: 东西直行</span>
                                            <span class="text-emerald-600 font-medium">D: 东西左转</span>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section class="glass-card rounded-xl overflow-hidden shadow-sm">
                                <div class="bg-slate-50 px-6 py-3 border-b border-slate-100 flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="w-6 h-6 flex items-center justify-center bg-blue-100 text-blue-600 rounded-md text-xs font-bold">03</span>
                                        <h4 class="font-bold text-slate-700">交通流实时参数</h4>
                                    </div>
                                </div>
                                <div class="p-6 grid grid-cols-2 gap-6 text-sm">
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">总流量到达率 λ_total (veh/h)</label>
                                        <input id="param-lambda-total" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none" type="number" value="1200" min="200" max="3000">
                                    </div>
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">直行车占比 p_s (0-1)</label>
                                        <div class="flex items-center space-x-3">
                                            <input id="param-ps" class="flex-1 accent-blue-600" max="1" min="0" step="0.01" type="range" value="0.75" oninput="document.getElementById('ps-value').innerText = this.value">
                                            <span id="ps-value" class="font-mono text-blue-600 font-bold w-12 text-right">0.75</span>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">行人到达率 λ_p (人/min)</label>
                                        <input id="param-lambda-p" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none" type="number" value="15" min="0" max="60">
                                    </div>
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">右转车到达率 λ_r (veh/h)</label>
                                        <input id="param-lambda-r" class="w-full px-4 py-2 rounded-lg border border-slate-200 focus:border-blue-500 outline-none" type="number" value="300" min="0" max="1000">
                                        <p class="text-[10px] text-slate-400 mt-1">可手动输入或自动计算 (λ_r = λ_total × (1 - p_s))</p>
                                    </div>
                                </div>
                            </section>
                            <section class="glass-card rounded-xl overflow-hidden shadow-sm">
                                <div class="bg-slate-50 px-6 py-3 border-b border-slate-100">
                                    <div class="flex items-center space-x-2">
                                        <span class="w-6 h-6 flex items-center justify-center bg-blue-100 text-blue-600 rounded-md text-xs font-bold">04</span>
                                        <h4 class="font-bold text-slate-700">驾驶行为与饱和流率</h4>
                                    </div>
                                </div>
                                <div class="p-6 grid grid-cols-3 gap-6">
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">行人过街均时 τ (s)</label>
                                        <input id="param-tau" class="w-full px-4 py-2 rounded-lg border border-slate-200" step="0.1" type="number" value="4.5">
                                    </div>
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">车辆跟驰时距 t_f (s)</label>
                                        <input id="param-tf" class="w-full px-4 py-2 rounded-lg border border-slate-200" step="0.1" type="number" value="2.2">
                                    </div>
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">饱和流率 s_r (veh/h)</label>
                                        <input id="param-sr" class="w-full px-4 py-2 rounded-lg border border-slate-200" type="number" value="1800">
                                    </div>
                                    <div class="input-group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">直行饱和流率 s_s (veh/h)</label>
                                        <input id="param-ss" class="w-full px-4 py-2 rounded-lg border border-slate-200" type="number" value="1800">
                                    </div>
                                </div>
                            </section>
                            <div class="flex justify-end space-x-4">
                                <button onclick="resetParams()" class="px-6 py-3 border border-slate-200 text-slate-600 rounded-lg font-medium hover:bg-slate-100 transition-colors flex items-center">
                                    <span class="iconify mr-2" data-icon="mdi:refresh"></span>重置参数
                                </button>
                                <button class="px-10 py-3 bg-blue-600 text-white rounded-lg font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-all flex items-center" onclick="startAnalysis()">
                                    <span class="iconify mr-2" data-icon="mdi:play-circle-outline"></span>执行协同计算
                                </button>
                            </div>
                        </div>
                        <div class="w-[450px] space-y-6">
                            <div class="glass-card p-6 rounded-xl overflow-hidden">
                                <h4 class="font-bold text-slate-700 mb-4 flex items-center justify-between">
<span class="flex items-center">
<span class="iconify mr-2 text-blue-500" data-icon="mdi:map-marker-radius"></span>
几何建模与冲突分析
</span>
                                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">四相位示意图</span>
                                </h4>
                                <div class="relative bg-slate-900 rounded-lg overflow-hidden" id="intersection-image-container">
                                    <img id="phase-image" src="https://picui.ogmua.cn/s1/2026/02/27/69a1a4ffd4b2b.webp" class="intersection-phase-img" alt="路口相位示意图">
                                    <div class="absolute bottom-2 left-2 right-2 bg-white/90 backdrop-blur rounded-lg p-2 border border-slate-200">
                                        <div class="text-[10px] text-slate-500 mb-1 font-bold">冲突演示控制</div>
                                        <div class="flex gap-1">
                                            <button onclick="switchPhaseImage('a')" class="flex-1 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-[10px] font-medium transition-colors border-2 border-transparent" id="btn-phase-a">相位A</button>
                                            <button onclick="switchPhaseImage('b')" class="flex-1 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded text-[10px] font-medium transition-colors border-2 border-transparent" id="btn-phase-b">相位B</button>
                                            <button onclick="switchPhaseImage('c')" class="flex-1 py-1 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded text-[10px] font-medium transition-colors border-2 border-transparent" id="btn-phase-c">相位C</button>
                                            <button onclick="switchPhaseImage('d')" class="flex-1 py-1 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 rounded text-[10px] font-medium transition-colors border-2 border-transparent" id="btn-phase-d">相位D</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 space-y-2 text-xs text-slate-600 bg-slate-50 p-3 rounded-lg">
                                    <div class="flex items-center gap-2">
                                        <span class="w-4 h-4 bg-blue-500 rounded-sm"></span>
                                        <span>蓝色箭头：直行车流</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-4 h-4 bg-green-500 rounded-sm"></span>
                                        <span>绿色箭头：右转车流</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-4 h-4 bg-yellow-400 rounded-sm"></span>
                                        <span>黄色箭头：人流</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-4 h-4 bg-red-500 rounded-full"></span>
                                        <span>红色圆圈：冲突位置</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-blue-900 to-indigo-900 rounded-xl p-6 text-white shadow-xl">
                                <div class="flex items-center space-x-2 mb-4">
                                    <span class="iconify text-blue-300" data-icon="mdi:alert-circle-outline"></span>
                                    <span class="font-bold">模型校验状态</span>
                                </div>
                                <ul class="text-xs space-y-3">
                                    <li class="flex items-center text-blue-200">
                                        <span class="iconify mr-2 text-green-400" data-icon="mdi:check-circle"></span>
                                        Gamma分布: 直行车到达模型
                                    </li>
                                    <li class="flex items-center text-blue-200">
                                        <span class="iconify mr-2 text-green-400" data-icon="mdi:check-circle"></span>
                                        Poisson分布: 堵塞概率计算
                                    </li>
                                    <li class="flex items-center text-blue-200">
                                        <span class="iconify mr-2 text-green-400" data-icon="mdi:check-circle"></span>
                                        间隙接受理论: 行人干扰模型
                                    </li>
                                    <li class="flex items-center text-blue-200">
                                        <span class="iconify mr-2 text-green-400" data-icon="mdi:check-circle"></span>
                                        四相位积分: 周期通行量期望
                                    </li>
                                </ul>
                                <div class="mt-4 pt-4 border-t border-white/20 text-[10px] text-blue-300">
                                    基于论文《考虑礼让行人和右转专用车道长度的右转车道通行能力模型》
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 页面: 分析结果展示页 - 修复图表显示 -->
                <div class="page-content hidden" id="page-analysis-content">
                    <div class="grid grid-cols-12 gap-8">
                        <!-- 左侧：核心指标 -->
                        <div class="col-span-12 xl:col-span-4 space-y-6">
                            <!-- 通行能力大卡片 -->
                            <div class="bg-gradient-to-br from-blue-700 to-indigo-800 rounded-3xl p-8 text-white shadow-xl relative overflow-hidden">
                                <div class="relative z-10">
                                    <div class="text-blue-200 text-sm font-bold tracking-widest uppercase mb-1">最终通行能力</div>
                                    <div class="text-5xl xl:text-6xl font-black mb-4 tracking-tighter break-all" id="result-capacity">--</div>
                                    <div class="text-blue-100 opacity-80 text-sm">车辆 / 小时 (veh/h)</div>
                                    <div class="mt-6 flex items-center gap-2">
                                        <span class="px-2 py-1 bg-white/20 rounded text-xs" id="result-status">等待计算</span>
                                        <span class="text-xs text-blue-200">置信度: 96.8%</span>
                                    </div>
                                    <div class="mt-8 pt-8 border-t border-white/20 grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-xs text-blue-200 opacity-60">期望周期通过量</p>
                                            <p class="text-xl font-bold" id="result-cycle-vol">-- <span class="text-xs">辆/周期</span></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-blue-200 opacity-60">道路负荷率</p>
                                            <p class="text-xl font-bold" id="result-vc-ratio">--</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="absolute -right-10 -bottom-10 opacity-10">
                                    <span class="iconify" data-icon="mdi:road-variant" data-width="200"></span>
                                </div>
                            </div>
                            <!-- 关键概率指标 -->
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wider">关键概率指标</h4>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-slate-600">周期初始堵塞概率</span>
                                            <span class="font-mono font-bold text-red-600" id="prob-block-init">--%</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-red-500 rounded-full transition-all duration-500" id="prob-block-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-slate-600">行人干扰通行能力 C_ped</span>
                                            <span class="font-mono font-bold text-blue-600" id="result-c-ped">-- veh/h</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-blue-500 rounded-full transition-all duration-500" id="c-ped-bar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-slate-600">纯右转饱和流率</span>
                                            <span class="font-mono font-bold text-slate-600" id="result-sr-display">1800 veh/h</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-slate-400 rounded-full" style="width: 100%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 六维雷达图 -->
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="font-bold text-slate-800 mb-4 flex items-center">
                                    <span class="iconify mr-2 text-orange-500" data-icon="mdi:radar"></span>
                                    六维瓶颈分析雷达图
                                </h4>
                                <div style="width: 100%; height: 300px;" id="radar-chart"></div>
                                <p class="text-xs text-slate-500 italic mt-2 text-center">* 相位A-D堵塞概率 + 通行限制 + 瓶颈贡献</p>
                            </div>
                        </div>

                        <!-- 右侧：详细分析 -->
                        <div class="col-span-12 xl:col-span-8 space-y-6">
                            <!-- 相位分布与柱状图 -->
                            <div class="glass-card rounded-2xl p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h4 class="font-bold text-slate-800 flex items-center">
                                        <span class="iconify mr-2 text-blue-500" data-icon="mdi:clock-fast"></span>
                                        信号周期内堵塞概率分布与通行能力
                                    </h4>
                                    <div class="flex space-x-2 text-[10px]">
                                        <span class="flex items-center"><span class="w-2 h-2 bg-red-500 rounded-full mr-1"></span> 极高风险</span>
                                        <span class="flex items-center"><span class="w-2 h-2 bg-amber-500 rounded-full mr-1"></span> 中等风险</span>
                                        <span class="flex items-center"><span class="w-2 h-2 bg-emerald-500 rounded-full mr-1"></span> 低风险</span>
                                    </div>
                                </div>
                                <!-- 相位时间轴 -->
                                <div class="mb-6">
                                    <div class="flex justify-between text-xs text-slate-500 mb-2">
                                        <span>0s</span>
                                        <span id="timeline-ta">30s</span>
                                        <span id="timeline-tb">60s</span>
                                        <span id="timeline-tc">90s</span>
                                        <span id="timeline-C">120s</span>
                                    </div>
                                    <div class="h-24 w-full flex rounded-lg overflow-hidden border border-slate-200 shadow-inner mb-4" id="result-phase-bar">
                                        <div class="phase-bar flex flex-col items-center justify-center text-white text-xs relative group p-2" id="result-phase-a" style="flex: 1; background-color: #3b82f6;">
                                            <span class="font-bold text-sm mb-1">相位A</span>
                                            <span class="text-[10px] opacity-90 whitespace-nowrap" id="phase-a-prob">堵塞: --%</span>
                                            <span class="text-[10px] opacity-75 whitespace-nowrap" id="phase-a-vol">通行: --辆</span>
                                        </div>
                                        <div class="phase-bar flex flex-col items-center justify-center text-white text-xs relative group p-2" id="result-phase-b" style="flex: 1; background-color: #ef4444;">
                                            <span class="font-bold text-sm mb-1">相位B</span>
                                            <span class="text-[10px] opacity-90 whitespace-nowrap" id="phase-b-prob">堵塞: --%</span>
                                            <span class="text-[10px] opacity-75 whitespace-nowrap" id="phase-b-vol">通行: --辆</span>
                                        </div>
                                        <div class="phase-bar flex flex-col items-center justify-center text-white text-xs relative group p-2" id="result-phase-c" style="flex: 1; background-color: #f59e0b;">
                                            <span class="font-bold text-sm mb-1">相位C</span>
                                            <span class="text-[10px] opacity-90 whitespace-nowrap" id="phase-c-prob">堵塞: --%</span>
                                            <span class="text-[10px] opacity-75 whitespace-nowrap" id="phase-c-vol">通行: --辆</span>
                                        </div>
                                        <div class="phase-bar flex flex-col items-center justify-center text-white text-xs relative group p-2" id="result-phase-d" style="flex: 1; background-color: #10b981;">
                                            <span class="font-bold text-sm mb-1">相位D</span>
                                            <span class="text-[10px] opacity-90 whitespace-nowrap" id="phase-d-prob">堵塞: --%</span>
                                            <span class="text-[10px] opacity-75 whitespace-nowrap" id="phase-d-vol">通行: --辆</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- 各相位通过量柱状图 -->
                                <div style="width: 100%; height: 350px;" id="bar-chart"></div>
                            </div>

                            <!-- 新增：各相位多维指标对比柱状图 -->
                            <div class="glass-card rounded-2xl p-6">
                                <h4 class="font-bold text-slate-800 mb-4 flex items-center">
                                    <span class="iconify mr-2 text-purple-500" data-icon="mdi:chart-bar"></span>
                                    各相位多维指标对比
                                </h4>
                                <div style="width: 100%; height: 280px;" id="phase-bar-chart"></div>
                                <p class="text-xs text-slate-500 italic mt-2 text-center">* 堵塞概率 | 通行能力限制 | 瓶颈贡献度</p>
                            </div>

                            <!-- 详细数据表格 -->
                            <div class="glass-card rounded-2xl overflow-hidden">
                                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50">
                                    <h4 class="font-bold text-slate-800 text-sm">分相位计算详情</h4>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm min-w-[600px]">
                                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                        <tr>
                                            <th class="px-6 py-3 text-left">相位</th>
                                            <th class="px-6 py-3 text-left">时段</th>
                                            <th class="px-6 py-3 text-right">堵塞概率</th>
                                            <th class="px-6 py-3 text-right">期望通行量(辆)</th>
                                            <th class="px-6 py-3 text-center">限制因素</th>
                                        </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100" id="phase-detail-table">
                                        <!-- 动态生成 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 页面: 敏感度分析 -->
                <div class="page-content hidden" id="page-sensitivity-content">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-slate-800 mb-2">敏感度分析</h3>
                        <p class="text-slate-500">基于三维曲面图分析关键参数对通行能力的影响权重</p>
                    </div>
                    <div class="glass-card rounded-xl p-4 mb-6 flex flex-wrap items-center gap-4">
                        <span class="text-sm font-bold text-slate-700">选择分析维度：</span>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="switchSensitivityChart(1)" id="btn-sens-1" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors">
                                直行车比例 vs 车道容量
                            </button>
                            <button onclick="switchSensitivityChart(2)" id="btn-sens-2" class="px-4 py-2 bg-slate-200 text-slate-700 hover:bg-slate-300 rounded-lg text-sm font-medium transition-colors">
                                直行车比例 vs 行人到达率
                            </button>
                            <button onclick="switchSensitivityChart(3)" id="btn-sens-3" class="px-4 py-2 bg-slate-200 text-slate-700 hover:bg-slate-300 rounded-lg text-sm font-medium transition-colors">
                                车道容量 vs 行人到达率
                            </button>
                        </div>
                        <div class="ml-auto flex items-center gap-2 text-xs text-slate-500">
                            <span class="iconify" data-icon="mdi:mouse-move"></span>
                            <span>支持旋转、缩放、平移查看</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-12 gap-6">
                        <div class="col-span-12 lg:col-span-8">
                            <div class="glass-card rounded-2xl p-6">
                                <div id="sensitivity-3d-chart" style="width: 100%; height: 600px;"></div>
                            </div>
                        </div>
                        <div class="col-span-12 lg:col-span-4 space-y-6">
                            <div class="glass-card rounded-2xl p-6 border-2 border-blue-100">
                                <h4 class="font-bold text-slate-800 mb-4 flex items-center">
                                    <span class="iconify mr-2 text-blue-600" data-icon="mdi:calculator-variant"></span>
                                    参数点计算器
                                </h4>
                                <p class="text-xs text-slate-500 mb-4">在下方输入具体参数值，计算该点的通行能力并在图上标记</p>
                                <div id="sensitivity-inputs" class="space-y-4">
                                </div>
                                <button onclick="calculateSensitivityPoint()" class="w-full mt-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center">
                                    <span class="iconify mr-2" data-icon="mdi:map-marker-plus"></span>
                                    计算并标记该点
                                </button>
                            </div>
                            <div class="glass-card rounded-2xl p-6 bg-gradient-to-br from-slate-50 to-blue-50">
                                <h4 class="font-bold text-slate-800 mb-3">当前标记点信息</h4>
                                <div id="point-info" class="space-y-3 text-sm">
                                    <div class="flex justify-between items-center py-2 border-b border-slate-200">
                                        <span class="text-slate-500">X轴参数</span>
                                        <span class="font-mono font-bold text-slate-700" id="point-x">--</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-slate-200">
                                        <span class="text-slate-500">Y轴参数</span>
                                        <span class="font-mono font-bold text-slate-700" id="point-y">--</span>
                                    </div>
                                    <div class="flex justify-between items-center py-2 border-b border-slate-200">
                                        <span class="text-slate-500">Z轴数值</span>
                                        <span class="font-mono font-bold text-blue-600 text-lg" id="point-z">--</span>
                                    </div>
                                    <div class="pt-2">
                                        <p class="text-xs text-slate-400 italic" id="point-desc">点击"计算并标记"按钮查看结果</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 页面: 优化建议页 -->
                <div class="page-content hidden" id="page-optimize-content">
                    <div class="max-w-4xl mx-auto space-y-8">
                        <div class="flex items-center justify-between">
                            <h3 class="text-2xl font-bold flex items-center">
                                <span class="iconify mr-3 text-blue-600" data-icon="mdi:clipboard-check-multiple-outline"></span>
                                瓶颈诊断与优化建议方案
                            </h3>
                            <button onclick="exportReport()" class="px-4 py-2 bg-slate-800 text-white rounded-lg flex items-center text-sm hover:bg-slate-700 transition-colors">
                                <span class="iconify mr-2" data-icon="mdi:printer"></span>打印分析报告
                            </button>
                        </div>
                        <div class="glass-card rounded-2xl p-6 bg-gradient-to-r from-slate-50 to-blue-50 border border-blue-100">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white shrink-0">
                                    <span class="iconify" data-icon="mdi:chart-donut" data-width="24"></span>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-slate-800 mb-2">智能诊断摘要</h4>
                                    <p class="text-slate-600 text-sm leading-relaxed" id="optimize-summary">
                                        正在分析路口数据，请先在"参数配置"页面执行计算...
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6" id="optimize-suggestions">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Toast提醒 -->
<div class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full opacity-0 translate-y-10 transition-all z-50 pointer-events-none flex items-center" id="toast">
    <span class="iconify mr-2 text-blue-400" data-icon="mdi:sync"></span>
    <span id="toast-text">正在处理...</span>
</div>

<script>
    // 相位图片URL映射
    const phaseImages = {
    a: 'https://picui.ogmua.cn/s1/2026/02/27/69a1a4ffd4b2b.webp',
    b: 'https://picui.ogmua.cn/s1/2026/02/27/69a1a5001c6c3.webp',
    c: 'https://picui.ogmua.cn/s1/2026/02/27/69a1a5003a7d4.webp',
    d: 'https://picui.ogmua.cn/s1/2026/02/27/69a1a50035eba.webp'
    };

    function switchPhaseImage(phase) {
    const img = document.getElementById('phase-image');
    if (img && phaseImages[phase]) {
    img.src = phaseImages[phase];
    }
    ['a', 'b', 'c', 'd'].forEach(p => {
    const btn = document.getElementById('btn-phase-' + p);
    if (p === phase) {
    btn.classList.add('ring-2', 'ring-offset-1');
    btn.classList.add(p === 'a' ? 'ring-blue-500' : p === 'b' ? 'ring-red-500' : p === 'c' ? 'ring-amber-500' : 'ring-emerald-500');
    } else {
    btn.classList.remove('ring-2', 'ring-offset-1', 'ring-blue-500', 'ring-red-500', 'ring-amber-500', 'ring-emerald-500');
    }
    });
    showToast(`已切换到相位${phase.toUpperCase()}视图`, 1500);
    }

    // 登录注册功能
    function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(el => {
    el.classList.remove('active', 'text-slate-800');
    el.classList.add('text-slate-500');
    });
    event.target.classList.add('active');
    event.target.classList.remove('text-slate-500');

    if (tab === 'login') {
    document.getElementById('login-form').classList.add('active');
    document.getElementById('register-form').classList.remove('active');
    } else {
    document.getElementById('login-form').classList.remove('active');
    document.getElementById('register-form').classList.add('active');
    }
    }

    let countdown = 0;
    function sendVerifyCode() {
    const phone = document.getElementById('reg-phone').value;
    if (!phone || phone.length !== 11) {
    showToast('请输入正确的11位手机号', 2000);
    return;
    }
    const btn = document.getElementById('send-code-btn');
    if (countdown > 0) return;
    showToast('验证码已发送（演示模式：123456）', 2000);
    countdown = 60;
    btn.disabled = true;
    btn.textContent = `${countdown}秒后重试`;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    const timer = setInterval(() => {
    countdown--;
    if (countdown <= 0) {
    clearInterval(timer);
    btn.disabled = false;
    btn.textContent = '获取验证码';
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
    btn.textContent = `${countdown}秒后重试`;
    }
    }, 1000);
    }

    function handleLogin() {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    if (!username || !password) {
    showToast('请输入账号和密码', 2000);
    return;
    }
    showToast('登录成功', 1500);
    setTimeout(() => {
    navigateTo('page-dashboard');
    }, 500);
    }

    function handleRegister() {
    const username = document.getElementById('reg-username').value;
    const password = document.getElementById('reg-password').value;
    const confirmPassword = document.getElementById('reg-password-confirm').value;
    const phone = document.getElementById('reg-phone').value;
    const code = document.getElementById('reg-code').value;
    if (!username || !password || !phone || !code) {
    showToast('请填写所有必填项', 2000);
    return;
    }
    if (password !== confirmPassword) {
    showToast('两次输入的密码不一致', 2000);
    return;
    }
    if (code !== '123456') {
    showToast('验证码错误（演示模式请输入123456）', 2000);
    return;
    }
    showToast('注册成功，请登录', 2000);
    switchAuthTab('login');
    document.getElementById('login-username').value = username;
    }

    // 数学计算引擎
    const MathEngine = {
    gamma: function(z) {
    const g = 7;
    const C = [0.99999999999980993, 676.5203681218851, -1259.1392167224028, 771.32342877765313, -176.61502916214059, 12.507343278686905, -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
    if (z < 0.5) {
    return Math.PI / (Math.sin(Math.PI * z) * this.gamma(1 - z));
    }
    z -= 1;
    let x = C[0];
    for (let i = 1; i < g + 2; i++) {
    x += C[i] / (z + i);
    }
    const t = z + g + 0.5;
    return Math.sqrt(2 * Math.PI) * Math.pow(t, z + 0.5) * Math.exp(-t) * x;
    },
    gammainc: function(a, x) {
    if (x < 0) return 0;
    if (x === 0) return 0;
    let sum = 0;
    let term = 1 / a;
    let n = 1;
    while (Math.abs(term) > 1e-10 && n < 1000) {
    sum += term;
    term *= x / (a + n);
    n++;
    }
    return sum * Math.exp(-x + a * Math.log(x)) / this.gamma(a);
    },
    gammaPDF: function(t, a, scale) {
    if (t <= 0 || scale <= 0) return 0;
    const x = t / scale;
    return Math.pow(x, a - 1) * Math.exp(-x) / (scale * this.gamma(a));
    },
    gammaCDF: function(t, a, scale) {
    if (t <= 0) return 0;
    return this.gammainc(a, t / scale);
    },
    poissonCDF: function(k, mu) {
    if (mu <= 0) return k >= 0 ? 1 : 0;
    return 1 - this.gammainc(k + 1, mu);
    },
    quad: function(f, a, b, n = 100) {
    if (a >= b) return [0, 0];
    const h = (b - a) / n;
    let sum = f(a) + f(b);
    for (let i = 1; i < n; i++) {
    const x = a + i * h;
    sum += (i % 2 === 0) ? 2 * f(x) : 4 * f(x);
    }
    return [sum * h / 3, 0];
    },
    calculateCapacity: function(n, C, r_total_vph, p_s, lambda_p_ppm, tau, t_f, s_r_vph, s_s_vph, t_a, t_b, t_c) {
    const r_s = (r_total_vph / 3600.0) * p_s;
    const lambda_p = lambda_p_ppm / 60.0;
    const s_r = s_r_vph / 3600.0;
    const s_s = s_s_vph / 3600.0;
    const k = n + 1;
    const t_d = C;
    const t0 = 0.0;

    const f_T = (t) => {
    if (r_s <= 1e-9) return 0;
    try {
    return this.gammaPDF(t, k, 1 / r_s);
    } catch (e) {
    return 0;
    }
    };

    const F_T = (t) => {
    if (r_s <= 1e-9) return t > 0 ? 1.0 : 0.0;
    try {
    return this.gammaCDF(t, k, 1 / r_s);
    } catch (e) {
    return t > 0 ? 1.0 : 0.0;
    }
    };

    const P_a = F_T(t_b) - F_T(t_a);
    const P_b = F_T(t_c) - F_T(t_b);
    const P_c = F_T(t_d) - F_T(t_c);
    const P_d = 1.0 - F_T(t_d);

    const calculate_C_ped = (lambda_p, tau, t_f) => {
    if (lambda_p <= 1e-9) return Infinity;
    const numerator = lambda_p * Math.exp(-lambda_p * tau);
    const denominator = 1 - Math.exp(-lambda_p * t_f);
    if (Math.abs(denominator) < 1e-9) return Infinity;
    return numerator / denominator;
    };

    const C_ped_raw = calculate_C_ped(lambda_p, tau, t_f);
    const C_ped = Math.min(C_ped_raw, s_r);

    const prob_unblock_prev = this.poissonCDF(n, r_s * C);
    const P_block_prev = 1.0 - prob_unblock_prev;

    let Q0 = 0;
    const P0 = P_a + P_b + P_c;
    if (P0 > 1e-9 && r_s > 1e-9) {
    const t_red = t_d - t_a;
    const mu_q0 = r_s * t_red;
    try {
    const poisson_cdf_val = this.poissonCDF(n - 1, mu_q0);
    const summation_term = poisson_cdf_val * Math.exp(mu_q0);
    const numerator_q0 = mu_q0 * (1 - Math.exp(-mu_q0) * summation_term);
    Q0 = numerator_q0 / P0;
    } catch (e) {
    Q0 = r_s * t_red;
    }
    }

    let t_clear = 0;
    if ((s_s - r_s) > 1e-6 && Q0 > n) {
    t_clear = (Q0 - n) / (s_s - r_s);
    }

    const effective_time_blocked = Math.max(0, (t_a - t0) - t_clear);
    const C_A_block = C_ped * effective_time_blocked;
    const C_A_unblock = C_ped * (t_a - t0);
    const E_CA = P_block_prev * C_A_block + prob_unblock_prev * C_A_unblock;

    const V_a = (t) => s_r * (t - t_a);
    const V_b = (t) => s_r * (t_b - t_a) + C_ped * (t - t_b);
    const V_c = (t) => s_r * (t_b - t_a) + C_ped * (t_c - t_b) + s_r * (t - t_c);

    let E_a = 0, E_b = 0, E_c = 0;
    try {
    [E_a] = this.quad((t) => V_a(t) * f_T(t), t_a, t_b);
    [E_b] = this.quad((t) => V_b(t) * f_T(t), t_b, t_c);
    [E_c] = this.quad((t) => V_c(t) * f_T(t), t_c, t_d);
    } catch (e) {
    E_a = E_b = E_c = 0;
    }

    const V_d_max = s_r * (t_b - t_a) + C_ped * (t_c - t_b) + s_r * (t_d - t_c);
    const E_d = V_d_max * P_d;
    const E_risk = E_a + E_b + E_c + E_d;
    const E_total = E_CA + E_risk;
    const Capacity_vph = C <= 1e-9 ? 0 : E_total * (3600.0 / C);

    return {
    capacity: Capacity_vph,
    E_total: E_total,
    E_CA: E_CA,
    C_ped: C_ped * 3600,
    P_block_prev: P_block_prev,
    prob_unblock_prev: prob_unblock_prev,
    phase_probs: { A: P_a, B: P_b, C: P_c, D: P_d },
    phase_volumes: { A: E_a, B: E_b, C: E_c, D: E_d },
    Q0: Q0,
    t_clear: t_clear,
    raw_params: { n, C, r_s, lambda_p, s_r, k }
    };
    }
    };

    // 应用状态管理
    const AppState = {
    params: {
    n: 10,
    C: 120,
    t_a: 30,
    t_b: 60,
    t_c: 90,
    r_total_vph: 1200,
    p_s: 0.75,
    lambda_p_ppm: 15,
    tau: 4.5,
    t_f: 2.2,
    s_r_vph: 1800,
    s_s_vph: 1800,
    lambda_r_vph: 300
    },
    results: null,
    currentProjectId: null,
    projects: [
    {
    id: 1,
    name: '长安大街与建国路路口西北角',
    type: '右转口袋车道',
    location: '北京市朝阳区建国路88号',
    lat: 39.9042,
    lng: 116.4074,
    lastModified: '2026-02-27 14:20',
    capacity: 452,
    status: 'completed',
    desc: '主干道交汇口，早晚高峰流量大',
    params: null
    },
    {
    id: 2,
    name: '经十路与奥体西路交叉口',
    type: '右转口袋车道',
    location: '济南市历下区经十路',
    lat: 36.6512,
    lng: 117.1201,
    lastModified: '2026-02-26 09:15',
    capacity: 389,
    status: 'completed',
    desc: '奥体中心周边，赛事期间流量激增',
    params: null
    },
    {
    id: 3,
    name: '解放路实验段',
    type: '右转口袋车道',
    location: '上海市黄浦区解放路',
    lat: 31.2304,
    lng: 121.4737,
    lastModified: '2026-02-25 18:30',
    capacity: null,
    status: 'calculating',
    desc: '新建道路测试段',
    params: null
    }
    ],
    totalAnalysisCount: 50,
    updateParam: function(key, value) {
    this.params[key] = parseFloat(value);
    if (key === 'r_total_vph' || key === 'p_s') {
    const calculated_r = this.params.r_total_vph * (1 - this.params.p_s);
    if (!this.params.manual_lambda_r) {
    this.params.lambda_r_vph = calculated_r;
    const el = document.getElementById('param-lambda-r');
    if (el) el.value = Math.round(calculated_r);
    }
    }
    if (key === 'lambda_r_vph') {
    this.params.manual_lambda_r = true;
    }
    this.validateParams();
    this.calculate();
    this.updateUI();
    },
    validateParams: function() {
    const p = this.params;
    if (p.t_a < 0) p.t_a = 0;
    if (p.t_b <= p.t_a) p.t_b = p.t_a + 10;
    if (p.t_c <= p.t_b) p.t_c = p.t_b + 10;
    if (p.t_c >= p.C) p.t_c = p.C - 10;
    if (p.t_c <= p.t_b) p.t_c = p.t_b + 10;
    if (p.p_s < 0) p.p_s = 0;
    if (p.p_s > 1) p.p_s = 1;
    },
    calculate: function() {
    const p = this.params;
    this.results = MathEngine.calculateCapacity(
    p.n, p.C, p.r_total_vph, p.p_s, p.lambda_p_ppm,
    p.tau, p.t_f, p.s_r_vph, p.s_s_vph,
    p.t_a, p.t_b, p.t_c
    );
    },
    updateUI: function() {
    this.updatePhaseVisualization();
    this.updateInputDisplays();
    },
    updateInputDisplays: function() {
    document.getElementById('phase-ta-label').textContent = this.params.t_a + 's';
    document.getElementById('phase-tb-label').textContent = this.params.t_b + 's';
    document.getElementById('phase-tc-label').textContent = this.params.t_c + 's';
    document.getElementById('phase-C-label').textContent = this.params.C + 's';
    },
    updatePhaseVisualization: function() {
    const p = this.params;
    const phaseA = p.t_a;
    const phaseB = p.t_b - p.t_a;
    const phaseC = p.t_c - p.t_b;
    const phaseD = p.C - p.t_c;
    const bars = document.querySelectorAll('#phase-visual-bar > div');
    if (bars.length === 4) {
    bars[0].style.flex = phaseA;
    bars[1].style.flex = phaseB;
    bars[2].style.flex = phaseC;
    bars[3].style.flex = phaseD;
    }
    },
    setCurrentProject: function(projectId) {
    this.currentProjectId = projectId;
    const project = this.projects.find(p => p.id === projectId);
    if (project) {
    document.getElementById('current-project-badge').style.display = 'block';
    document.getElementById('current-project-name').textContent = project.name;
    document.getElementById('config-project-name').textContent = project.name;
    document.getElementById('config-project-location').textContent = project.location || '未设置位置';
    document.getElementById('project-info-banner').style.display = 'block';
    if (project.params) {
    this.params = {...project.params};
    this.syncParamsToInputs();
    }
    }
    },
    syncParamsToInputs: function() {
    const p = this.params;
    document.getElementById('param-n').value = p.n;
    document.getElementById('param-C').value = p.C;
    document.getElementById('param-ta').value = p.t_a;
    document.getElementById('param-tb').value = p.t_b;
    document.getElementById('param-tc').value = p.t_c;
    document.getElementById('param-lambda-total').value = p.r_total_vph;
    document.getElementById('param-ps').value = p.p_s;
    document.getElementById('ps-value').textContent = p.p_s;
    document.getElementById('param-lambda-p').value = p.lambda_p_ppm;
    document.getElementById('param-lambda-r').value = p.lambda_r_vph;
    document.getElementById('param-tau').value = p.tau;
    document.getElementById('param-tf').value = p.t_f;
    document.getElementById('param-sr').value = p.s_r_vph;
    document.getElementById('param-ss').value = p.s_s_vph;
    this.updateUI();
    },
    saveCurrentProject: function() {
    if (!this.currentProjectId) {
    showToast('请先选择一个项目', 2000);
    return;
    }
    const project = this.projects.find(p => p.id === this.currentProjectId);
    if (project) {
    project.params = {...this.params};
    project.lastModified = new Date().toLocaleString('zh-CN', {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
    }).replace(/\//g, '-');
    if (this.results) {
    project.capacity = Math.round(this.results.capacity);
    project.status = 'completed';
    }
    this.updateProjectTable();
    showToast('项目参数已保存', 2000);
    }
    },
    updateResults: function() {
    const r = this.results;
    const p = this.params;
    const capEl = document.getElementById('result-capacity');
    if (capEl) capEl.textContent = isNaN(r.capacity) ? 'Error' : r.capacity.toFixed(1);

    const cycleVolEl = document.getElementById('result-cycle-vol');
    if (cycleVolEl) cycleVolEl.innerHTML = (isNaN(r.E_total) ? '--' : r.E_total.toFixed(2)) + ' <span class="text-xs">辆/周期</span>';

    const demand = p.lambda_r_vph || (p.r_total_vph * (1 - p.p_s));
    const vcRatio = (r.capacity > 0) ? demand / r.capacity : 0;
    const vcEl = document.getElementById('result-vc-ratio');
    if (vcEl) vcEl.textContent = vcRatio.toFixed(2);

    const statusEl = document.getElementById('result-status');
    if (statusEl) {
    if (vcRatio > 0.9) {
    statusEl.textContent = '严重拥堵';
    statusEl.className = 'px-2 py-1 bg-red-500 text-white rounded text-xs';
    } else if (vcRatio > 0.7) {
    statusEl.textContent = '轻度拥堵';
    statusEl.className = 'px-2 py-1 bg-amber-500 text-white rounded text-xs';
    } else {
    statusEl.textContent = '运行良好';
    statusEl.className = 'px-2 py-1 bg-emerald-500 text-white rounded text-xs';
    }
    }

    const blockProbEl = document.getElementById('prob-block-init');
    if (blockProbEl) blockProbEl.textContent = (r.P_block_prev * 100).toFixed(1) + '%';

    const cPedEl = document.getElementById('result-c-ped');
    if (cPedEl) cPedEl.textContent = (isNaN(r.C_ped) ? '--' : Math.round(r.C_ped).toLocaleString()) + ' veh/h';

    const srEl = document.getElementById('result-sr-display');
    if (srEl) srEl.textContent = p.s_r_vph + ' veh/h';

    const blockBar = document.getElementById('prob-block-bar');
    if (blockBar) blockBar.style.width = Math.min(r.P_block_prev * 100, 100) + '%';

    const cPedBar = document.getElementById('c-ped-bar');
    if (cPedBar) cPedBar.style.width = Math.min((r.C_ped / p.s_r_vph) * 100, 100) + '%';

    this.updatePhaseDetails(r, p);
    this.updatePhaseTable(r, p);
    updateCharts(r);
    },
    updatePhaseDetails: function(r, p) {
    const taEl = document.getElementById('timeline-ta');
    const tbEl = document.getElementById('timeline-tb');
    const tcEl = document.getElementById('timeline-tc');
    const cEl = document.getElementById('timeline-C');
    if (taEl) taEl.textContent = p.t_a + 's';
    if (tbEl) tbEl.textContent = p.t_b + 's';
    if (tcEl) tcEl.textContent = p.t_c + 's';
    if (cEl) cEl.textContent = p.C + 's';

    const phaseA = p.t_a;
    const phaseB = p.t_b - p.t_a;
    const phaseC = p.t_c - p.t_b;
    const phaseD = p.C - p.t_c;

    const phases = [
    { id: 'a', name: 'A', width: phaseA, prob: r.phase_probs.A, vol: r.phase_volumes.A, color: '#3b82f6' },
    { id: 'b', name: 'B', width: phaseB, prob: r.phase_probs.B, vol: r.phase_volumes.B, color: '#ef4444' },
    { id: 'c', name: 'C', width: phaseC, prob: r.phase_probs.C, vol: r.phase_volumes.C, color: '#f59e0b' },
    { id: 'd', name: 'D', width: phaseD, prob: r.phase_probs.D, vol: r.phase_volumes.D, color: '#10b981' }
    ];

    phases.forEach(phase => {
    const bar = document.getElementById('result-phase-' + phase.id);
    const probEl = document.getElementById('phase-' + phase.id + '-prob');
    const volEl = document.getElementById('phase-' + phase.id + '-vol');
    if (bar) {
    bar.style.flex = phase.width;
    if (phase.prob > 0.7) {
    bar.style.backgroundColor = phase.id === 'b' ? '#dc2626' : phase.id === 'c' ? '#d97706' : phase.color;
    } else {
    bar.style.backgroundColor = phase.color;
    }
    }
    if (probEl) probEl.textContent = '堵塞: ' + (phase.prob * 100).toFixed(1) + '%';
    if (volEl) volEl.textContent = '通行: ' + (isNaN(phase.vol) ? '--' : phase.vol.toFixed(1)) + '辆';
    });
    },
    updatePhaseTable: function(r, p) {
    const tbody = document.getElementById('phase-detail-table');
    if (!tbody) return;
    const phases = [
    { name: 'A', color: 'blue', start: 0, end: p.t_a, prob: r.phase_probs.A, vol: r.phase_volumes.A, factor: '行人干扰' },
    { name: 'B', color: 'red', start: p.t_a, end: p.t_b, prob: r.phase_probs.B, vol: r.phase_volumes.B, factor: '直行车溢出' },
    { name: 'C', color: 'amber', start: p.t_b, end: p.t_c, prob: r.phase_probs.C, vol: r.phase_volumes.C, factor: '混合干扰' },
    { name: 'D', color: 'emerald', start: p.t_c, end: p.C, prob: r.phase_probs.D, vol: r.phase_volumes.D, factor: '基本畅通' }
    ];
    tbody.innerHTML = phases.map(phase => `
    <tr>
    <td class="px-6 py-3 font-medium text-${phase.color}-600">相位${phase.name}</td>
    <td class="px-6 py-3 text-slate-500">${phase.start}s - ${phase.end}s</td>
    <td class="px-6 py-3 text-right font-mono ${phase.prob > 0.5 ? 'text-red-600 font-bold' : 'text-slate-600'}">${(phase.prob * 100).toFixed(1)}%</td>
    <td class="px-6 py-3 text-right font-mono font-bold">${isNaN(phase.vol) ? '--' : phase.vol.toFixed(2)}</td>
    <td class="px-6 py-3 text-center"><span class="px-2 py-1 bg-${phase.color}-100 text-${phase.color}-700 rounded text-xs">${phase.factor}</span></td>
    </tr>
    `).join('');
    },
    generateOptimizationSuggestions: function() {
    const r = this.results;
    const p = this.params;
    if (!r) return;
    const container = document.getElementById('optimize-suggestions');
    const summary = document.getElementById('optimize-summary');
    if (!container || !summary) return;

    const probs = r.phase_probs;
    const sortedPhases = Object.entries(probs).sort((a, b) => b[1] - a[1]);
    const [maxPhase, maxProb] = sortedPhases[0];
    const phaseNames = { A: '相位A（南北直行）', B: '相位B（南北左转）', C: '相位C（东西直行）', D: '相位D（东西左转）' };

    let summaryText = '';
    if (maxProb > 0.8) {
    summaryText = `基于当前路口参数分析，<span class="font-bold text-red-600">${phaseNames[maxPhase]}</span>是主要瓶颈，直行车溢出概率高达${(maxProb*100).toFixed(1)}%，导致右转车道在关键时段被完全阻塞。`;
    } else if (maxProb > 0.5) {
    summaryText = `基于当前路口参数分析，<span class="font-bold text-amber-600">${phaseNames[maxPhase]}</span>存在明显干扰，堵塞概率为${(maxProb*100).toFixed(1)}%，建议关注该时段的通行效率。`;
    } else {
    summaryText = `基于当前路口参数分析，<span class="font-bold text-emerald-600">路口整体运行良好</span>，各相位最大堵塞概率仅${(maxProb*100).toFixed(1)}%，当前配置较为合理。`;
    }

    const pedImpact = (r.C_ped < p.s_r_vph * 0.8) ? '行人干扰显著降低了通行能力。' : '行人干扰影响较小。';
    summary.innerHTML = summaryText + pedImpact;

    let suggestions = [];
    if (maxProb > 0.7) {
    suggestions.push({
    type: 'critical',
    title: `主瓶颈：${phaseNames[maxPhase]}直行车排队溢出 (极高风险)`,
    desc: `当前直行车比例较高 (${p.p_s})，导致在信号周期 ${maxPhase === 'A' ? '初始阶段' : maxPhase === 'B' ? p.t_a + 's-' + p.t_b + 's' : maxPhase === 'C' ? p.t_b + 's-' + p.t_c + 's' : p.t_c + 's-' + p.C + 's'} 期间，直行排队长度超过口袋车道入口的概率为 ${(maxProb*100).toFixed(1)}%。`,
    strategies: [
    `几何优化：将口袋车道 L 向前延伸，将容量 n 从 ${p.n} 提升至 ${Math.min(p.n + 5, 20)}。`,
    `信号优化：调整分相时刻，缩短${phaseNames[maxPhase]}时长或引入感应信号控制。`,
    `预期效果：通行能力可提升 ${Math.min((maxProb * 30), 40).toFixed(0)}-40%，堵塞概率降至 60% 以下。`
    ]
    });
    }

    if (r.C_ped < p.s_r_vph * 0.7) {
    suggestions.push({
    type: 'warning',
    title: '次瓶颈：行人过街随机干扰 (中等影响)',
    desc: `在非拥堵时段，行人流 (${p.lambda_p_ppm}人/min) 对右转车流的横穿干扰降低了 ${((1 - r.C_ped/p.s_r_vph)*100).toFixed(0)}% 的稳态通过率。`,
    strategies: [
    '建议增设行人二次过街安全岛。',
    '实施人车分相，完全物理隔离行人绿灯。'
    ]
    });
    }

    if (maxProb < 0.5 && r.C_ped > p.s_r_vph * 0.8) {
    suggestions.push({
    type: 'success',
    title: '优势总结',
    desc: '该路口饱和流率配置合理，物理基础设施基本满足平峰需求。重点在于维持当前配置并监控高峰时段流量变化。'
    });
    }

    container.innerHTML = suggestions.map(s => {
    const colors = {
    critical: { bg: 'red', border: 'red', icon: 'alert-decagram' },
    warning: { bg: 'amber', border: 'amber', icon: 'human-male-female' },
    success: { bg: 'green', border: 'green', icon: 'check-decagram' }
    };
    const c = colors[s.type];
    return `
    <div class="bg-${c.bg}-50 border-l-4 border-${c.border}-500 p-6 rounded-xl shadow-sm">
    <div class="flex items-start">
    <div class="w-10 h-10 bg-${c.bg}-100 text-${c.border}-600 rounded-full flex items-center justify-center shrink-0 mr-4">
    <span class="iconify" data-icon="mdi:${c.icon}" data-width="24"></span>
    </div>
    <div class="flex-1">
    <div class="flex items-center justify-between mb-1">
    <h4 class="text-lg font-bold text-${c.border}-900">${s.title}</h4>
    ${s.type === 'critical' ? '<span class="px-2 py-1 bg-red-200 text-red-800 rounded text-xs font-bold">优先级: P0</span>' : ''}
    </div>
    <p class="text-${c.border}-700 text-sm mb-4">${s.desc}</p>
    ${s.strategies ? `
    <div class="bg-white/80 p-4 rounded-lg border border-${c.border}-100">
    <p class="text-xs font-bold uppercase text-${c.border}-600 mb-3 flex items-center">
    <span class="iconify mr-1" data-icon="mdi:wrench"></span>
    优化整治策略：
    </p>
    <ul class="text-sm text-slate-700 space-y-2">
    ${s.strategies.map(str => `
    <li class="flex items-start">
    <span class="iconify mr-2 text-${c.border}-400 mt-0.5" data-icon="mdi:arrow-right-thin"></span>
    <span>${str}</span>
    </li>
    `).join('')}
    </ul>
    </div>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    },
    updateProjectTable: function() {
    const tbody = document.getElementById('project-table-body');
    if (!tbody) return;
    tbody.innerHTML = this.projects.map(p => `
    <tr class="hover:bg-slate-50/50 transition-colors cursor-pointer" onclick="loadProject(${p.id})">
    <td class="px-6 py-4 font-medium">${p.name}</td>
    <td class="px-6 py-4 text-slate-500">${p.type}</td>
    <td class="px-6 py-4 text-slate-500 text-xs">${p.location || '未设置'}</td>
    <td class="px-6 py-4 text-slate-500">${p.lastModified}</td>
    <td class="px-6 py-4 font-mono font-semibold ${p.capacity ? 'text-blue-600' : 'text-slate-400'}">${p.capacity || '---'}</td>
    <td class="px-6 py-4">
    ${p.status === 'completed'
    ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-md text-xs">已完成</span>'
    : '<span class="px-2 py-1 bg-amber-100 text-amber-700 rounded-md text-xs">计算中...</span>'}
    </td>
    <td class="px-6 py-4 text-blue-600 hover:underline" onclick="event.stopPropagation(); loadProject(${p.id})">继续分析</td>
    </tr>
    `).join('');
    },
    updateStats: function() {
    const totalEl = document.getElementById('stat-total-analysis');
    const activeEl = document.getElementById('stat-active-projects');
    const changeEl = document.getElementById('stat-analysis-change');
    const projChangeEl = document.getElementById('stat-projects-change');
    if (totalEl) totalEl.textContent = this.totalAnalysisCount;
    if (activeEl) activeEl.textContent = this.projects.length;
    if (changeEl) changeEl.textContent = '↑ ' + Math.round((this.totalAnalysisCount - 50) / 50 * 100) + '%';
    if (projChangeEl) projChangeEl.textContent = '本月新增' + Math.max(0, this.projects.length - 3);
    },
    addProject: function(project) {
    const newProject = {
    ...project,
    id: Date.now(),
    lastModified: new Date().toLocaleString('zh-CN', {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
    }).replace(/\//g, '-'),
    capacity: null,
    status: 'calculating',
    params: null
    };
    this.projects.unshift(newProject);
    this.totalAnalysisCount++;
    this.updateProjectTable();
    this.updateStats();
    return newProject.id;
    }
    };

    // 事件监听初始化
    function initEventListeners() {
    const inputs = [
    { id: 'param-n', key: 'n' },
    { id: 'param-C', key: 'C' },
    { id: 'param-ta', key: 't_a' },
    { id: 'param-tb', key: 't_b' },
    { id: 'param-tc', key: 't_c' },
    { id: 'param-lambda-total', key: 'r_total_vph' },
    { id: 'param-ps', key: 'p_s' },
    { id: 'param-lambda-p', key: 'lambda_p_ppm' },
    { id: 'param-tau', key: 'tau' },
    { id: 'param-tf', key: 't_f' },
    { id: 'param-sr', key: 's_r_vph' },
    { id: 'param-ss', key: 's_s_vph' },
    { id: 'param-lambda-r', key: 'lambda_r_vph' }
    ];
    inputs.forEach(({ id, key }) => {
    const el = document.getElementById(id);
    if (el) {
    el.addEventListener('input', (e) => {
    let value = e.target.value;
    if (key === 'p_s') {
    document.getElementById('ps-value').textContent = value;
    }
    AppState.updateParam(key, value);
    });
    }
    });
    }

    // 页面交互函数
    function navigateTo(pageId) {
    if (pageId === 'page-dashboard') {
    document.getElementById('page-login').classList.add('hidden');
    document.getElementById('main-structure').classList.remove('hidden');
    AppState.updateProjectTable();
    AppState.updateStats();
    }
    const contents = document.querySelectorAll('.page-content');
    contents.forEach(c => c.classList.add('hidden'));
    const navs = document.querySelectorAll('nav a');
    navs.forEach(n => n.classList.remove('sidebar-item-active'));
    navs.forEach(n => n.classList.add('text-slate-600', 'hover:bg-slate-50'));

    const activeContent = document.getElementById(pageId + '-content');
    if (activeContent) {
    activeContent.classList.remove('hidden');
    const titles = {
    'page-dashboard': '项目控制台',
    'page-config': '路口参数配置',
    'page-analysis': '通行能力计算报告',
    'page-sensitivity': '敏感度分析',
    'page-optimize': '智能优化策略建议'
    };
    document.getElementById('page-title').innerText = titles[pageId] || '路口通';
    const activeNav = document.getElementById('nav-' + pageId.split('-')[1]);
    if (activeNav) {
    activeNav.classList.add('sidebar-item-active');
    activeNav.classList.remove('text-slate-600', 'hover:bg-slate-50');
    }
    if (pageId === 'page-config') {
    AppState.updateUI();
    } else if (pageId === 'page-analysis') {
    if (!AppState.results) AppState.calculate();
    // 关键修复：使用 requestAnimationFrame 确保 DOM 渲染后再初始化图表
    requestAnimationFrame(() => {
    setTimeout(() => {
    AppState.updateResults();
    // 强制 resize 确保图表尺寸正确
    setTimeout(() => {
    if (radarChart) radarChart.resize();
    if (barChart) barChart.resize();
    if (phaseBarChart) phaseBarChart.resize();
    }, 100);
    }, 300);
    });
    } else if (pageId === 'page-sensitivity') {
    setTimeout(() => switchSensitivityChart(1), 100);
    } else if (pageId === 'page-optimize') {
    AppState.generateOptimizationSuggestions();
    }
    }
    }

    function showToast(text, duration = 2000) {
    const toast = document.getElementById('toast');
    document.getElementById('toast-text').innerText = text;
    toast.classList.replace('opacity-0', 'opacity-100');
    toast.classList.replace('translate-y-10', 'translate-y-0');
    setTimeout(() => {
    toast.classList.replace('opacity-100', 'opacity-0');
    toast.classList.replace('translate-y-0', 'translate-y-10');
    }, duration);
    }

    function resetParams() {
    AppState.params = {
    n: 10, C: 120, t_a: 30, t_b: 60, t_c: 90,
    r_total_vph: 1200, p_s: 0.75, lambda_p_ppm: 15,
    tau: 4.5, t_f: 2.2, s_r_vph: 1800, s_s_vph: 1800,
    lambda_r_vph: 300, manual_lambda_r: false
    };
    document.getElementById('param-n').value = 10;
    document.getElementById('param-C').value = 120;
    document.getElementById('param-ta').value = 30;
    document.getElementById('param-tb').value = 60;
    document.getElementById('param-tc').value = 90;
    document.getElementById('param-lambda-total').value = 1200;
    document.getElementById('param-ps').value = 0.75;
    document.getElementById('ps-value').textContent = '0.75';
    document.getElementById('param-lambda-p').value = 15;
    document.getElementById('param-lambda-r').value = 300;
    document.getElementById('param-tau').value = 4.5;
    document.getElementById('param-tf').value = 2.2;
    document.getElementById('param-sr').value = 1800;
    document.getElementById('param-ss').value = 1800;
    AppState.calculate();
    AppState.updateUI();
    showToast('参数已重置为默认值');
    }

    function startAnalysis() {
    showToast('正在执行Gamma-Poisson协同计算...', 1500);
    AppState.calculate();
    setTimeout(() => {
    showToast('计算完成，正在生成可视化报告...', 1000);
    setTimeout(() => navigateTo('page-analysis'), 500);
    }, 1000);
    }

    function saveProjectConfig() {
    AppState.saveCurrentProject();
    }

    function loadProject(projectId) {
    AppState.setCurrentProject(projectId);
    navigateTo('page-config');
    showToast('已加载项目数据', 1500);
    }

    // 项目新建相关函数
    function openProjectModal() {
    closeMapModal();
    document.getElementById('project-modal').classList.add('active');
    }

    function closeProjectModal() {
    document.getElementById('project-modal').classList.remove('active');
    document.getElementById('new-project-name').value = '';
    document.getElementById('new-project-location').value = '';
    document.getElementById('new-project-lat').value = '';
    document.getElementById('new-project-lng').value = '';
    document.getElementById('new-project-desc').value = '';
    document.getElementById('selected-address-display').classList.add('hidden');
    }

    function createNewProject() {
    const name = document.getElementById('new-project-name').value.trim();
    const type = document.getElementById('new-project-type').value;
    const location = document.getElementById('new-project-location').value;
    const lat = document.getElementById('new-project-lat').value;
    const lng = document.getElementById('new-project-lng').value;
    const desc = document.getElementById('new-project-desc').value;

    if (!name) {
    showToast('请输入项目名称', 2000);
    return;
    }

    const projectId = AppState.addProject({
    name,
    type,
    location,
    lat: lat || null,
    lng: lng || null,
    desc
    });

    closeProjectModal();
    AppState.setCurrentProject(projectId);
    navigateTo('page-config');
    showToast('项目创建成功，请配置参数', 2000);
    }

    // 地图相关
    let map = null;
    let mapMarker = null;
    let isSelectingForProject = false;
    let selectedAddress = '';

    function openMapForProject() {
    isSelectingForProject = true;
    document.getElementById('project-modal').classList.remove('active');
    setTimeout(() => {
    openMapModal();
    }, 100);
    }

    function openMapModal() {
    document.getElementById('map-modal').classList.add('active');
    setTimeout(() => {
    initMap();
    }, 200);
    }

    function initMap() {
    if (map) return;

    if (typeof AMap === 'undefined') {
    document.getElementById('map-container').innerHTML =
    '<div class="flex items-center justify-center h-full bg-slate-100 text-slate-500">' +
    '<div class="text-center"><p class="mb-2">地图加载失败</p><p class="text-sm">请检查网络连接或地图API密钥</p></div></div>';
    return;
    }

    map = new AMap.Map('map-container', {
    zoom: 12,
    center: [116.4074, 39.9042]
    });

    map.on('click', function(e) {
    const lng = e.lnglat.getLng();
    const lat = e.lnglat.getLat();
    setMapMarker(lng, lat);
    getAddressFromCoords(lng, lat);
    });

    AMap.plugin(['AMap.Geocoder', 'AMap.PlaceSearch'], function() {
    console.log('地图插件加载完成');
    });
    }

    function setMapMarker(lng, lat) {
    if (mapMarker) {
    map.remove(mapMarker);
    }
    mapMarker = new AMap.Marker({
    position: [lng, lat],
    map: map
    });
    updateLocationInfo(lng, lat, '正在获取地址...');
    }

    function getAddressFromCoords(lng, lat) {
    if (typeof AMap === 'undefined') return;

    AMap.plugin('AMap.Geocoder', function() {
    const geocoder = new AMap.Geocoder();
    geocoder.getAddress([lng, lat], function(status, result) {
    let address = '';
    if (status === 'complete' && result.regeocode) {
    address = result.regeocode.formattedAddress;
    selectedAddress = address;
    } else {
    address = `经度: ${lng.toFixed(4)}, 纬度: ${lat.toFixed(4)}`;
    selectedAddress = '';
    }
    updateLocationInfo(lng, lat, address);
    });
    });
    }

    function updateLocationInfo(lng, lat, address) {
    const infoDiv = document.getElementById('selected-location-info');
    infoDiv.innerHTML = `
    <div class="selected-location-box">
    <div class="coord">📍 坐标: ${lng.toFixed(6)}, ${lat.toFixed(6)}</div>
    <div class="address">${address || '未知位置'}</div>
    </div>
    `;
    infoDiv.dataset.lng = lng;
    infoDiv.dataset.lat = lat;
    }

    function closeMapModal() {
    document.getElementById('map-modal').classList.remove('active');
    if (isSelectingForProject) {
    setTimeout(() => {
    document.getElementById('project-modal').classList.add('active');
    }, 100);
    isSelectingForProject = false;
    }
    }

    function confirmMapLocation() {
    const infoDiv = document.getElementById('selected-location-info');
    const lng = parseFloat(infoDiv.dataset.lng);
    const lat = parseFloat(infoDiv.dataset.lat);

    if (isNaN(lng) || isNaN(lat)) {
    showToast('请先选择位置', 2000);
    return;
    }

    if (isSelectingForProject) {
    document.getElementById('new-project-location').value = selectedAddress || `${lng.toFixed(4)}, ${lat.toFixed(4)}`;
    document.getElementById('new-project-lat').value = lat;
    document.getElementById('new-project-lng').value = lng;
    const addrDisplay = document.getElementById('selected-address-display');
    addrDisplay.classList.remove('hidden');
    document.getElementById('address-text').textContent = selectedAddress || `${lng.toFixed(4)}, ${lat.toFixed(4)}`;
    document.getElementById('map-modal').classList.remove('active');
    setTimeout(() => {
    document.getElementById('project-modal').classList.add('active');
    isSelectingForProject = false;
    }, 100);
    showToast('位置选择成功', 2000);
    } else {
    closeMapModal();
    }
    }

    function searchMapLocation() {
    const keyword = document.getElementById('map-search-input').value.trim();
    if (!keyword) {
    showToast('请输入搜索关键词', 2000);
    return;
    }
    if (typeof AMap === 'undefined') {
    showToast('地图服务未加载', 2000);
    return;
    }

    AMap.plugin('AMap.PlaceSearch', function() {
    const placeSearch = new AMap.PlaceSearch({
    pageSize: 10,
    pageIndex: 1,
    city: '全国'
    });

    placeSearch.search(keyword, function(status, result) {
    if (status === 'complete' && result.info === 'OK' && result.poiList && result.poiList.pois.length > 0) {
    const poi = result.poiList.pois[0];
    const lng = poi.location.getLng();
    const lat = poi.location.getLat();
    map.setCenter([lng, lat]);
    map.setZoom(15);
    setMapMarker(lng, lat);
    selectedAddress = poi.name + ' - ' + poi.address;
    updateLocationInfo(lng, lat, selectedAddress);
    showToast(`已找到: ${poi.name}`, 2000);
    } else {
    showToast('未找到相关位置，请尝试其他关键词', 2000);
    }
    });
    });
    }

    // 图表初始化 - 修复版
    let radarChart = null;
    let barChart = null;
    let phaseBarChart = null;

    function updateCharts(r) {
    if (!r) return;

    // 关键修复：确保容器有明确尺寸
    const ensureSize = (id, defaultHeight) => {
    const el = document.getElementById(id);
    if (!el) return false;
    const rect = el.getBoundingClientRect();
    if (rect.width === 0 || rect.height === 0) {
    console.warn(`容器 #${id} 尺寸为0，设置默认高度`);
    el.style.width = '100%';
    el.style.height = defaultHeight + 'px';
    }
    return true;
    };

    // 1. 六维雷达图
    if (ensureSize('radar-chart', 300)) {
    if (radarChart) radarChart.dispose();
    radarChart = echarts.init(document.getElementById('radar-chart'));

    const probs = r.phase_probs;
    const vcRatio = (AppState.params.lambda_r_vph / r.capacity) || 0;
    const totalVol = r.E_total || 1;
    const contributions = [
    (r.phase_volumes.A / totalVol * 100),
    (r.phase_volumes.B / totalVol * 100),
    (r.phase_volumes.C / totalVol * 100),
    (r.phase_volumes.D / totalVol * 100)
    ];
    const maxContribution = Math.max(...contributions);

    radarChart.setOption({
    radar: {
    indicator: [
    { name: '相位A堵塞', max: 100 },
    { name: '相位B堵塞', max: 100 },
    { name: '相位C堵塞', max: 100 },
    { name: '相位D堵塞', max: 100 },
    { name: '通行限制', max: 100 },
    { name: '瓶颈贡献', max: 100 }
    ],
    shape: 'circle',
    splitNumber: 4,
    axisName: { color: '#64748b', fontSize: 11 }
    },
    series: [{
    type: 'radar',
    data: [{
    value: [
    probs.A * 100,
    probs.B * 100,
    probs.C * 100,
    probs.D * 100,
    Math.min(vcRatio * 100, 100),
    maxContribution
    ],
    name: '当前路口',
    areaStyle: { color: 'rgba(59, 130, 246, 0.3)' },
    lineStyle: { color: '#3b82f6', width: 2 },
    itemStyle: { color: '#3b82f6' }
    }]
    }]
    });
    }

    // 2. 原有柱状图 - 各相位通过量
    if (ensureSize('bar-chart', 350)) {
    if (barChart) barChart.dispose();
    barChart = echarts.init(document.getElementById('bar-chart'));

    barChart.setOption({
    title: {
    text: '各相位右转通过期望值',
    textStyle: { fontSize: 14, color: '#64748b', fontWeight: 'normal' },
    left: 'center'
    },
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
    xAxis: {
    type: 'category',
    data: ['相位A', '相位B', '相位C', '相位D'],
    axisLabel: { color: '#64748b' }
    },
    yAxis: {
    type: 'value',
    name: '车辆 (veh)',
    nameTextStyle: { color: '#64748b' },
    axisLabel: { color: '#64748b' },
    splitLine: { lineStyle: { color: '#e2e8f0' } }
    },
    series: [{
    name: '通过量',
    type: 'bar',
    data: [
    { value: r.phase_volumes.A || 0, itemStyle: { color: '#3b82f6' } },
    { value: r.phase_volumes.B || 0, itemStyle: { color: '#ef4444' } },
    { value: r.phase_volumes.C || 0, itemStyle: { color: '#f59e0b' } },
    { value: r.phase_volumes.D || 0, itemStyle: { color: '#10b981' } }
    ],
    barWidth: '50%',
    label: {
    show: true,
    position: 'top',
    formatter: '{c}',
    color: '#64748b'
    }
    }]
    });
    }

    // 3. 新增：各相位多维指标对比柱状图（三维分组）
    if (ensureSize('phase-bar-chart', 280)) {
    if (phaseBarChart) phaseBarChart.dispose();
    phaseBarChart = echarts.init(document.getElementById('phase-bar-chart'));

    const probs = r.phase_probs;
    const totalVol = r.E_total || 1;

    // 计算三个维度的数据
    const blockageData = [
    (probs.A * 100).toFixed(1),
    (probs.B * 100).toFixed(1),
    (probs.C * 100).toFixed(1),
    (probs.D * 100).toFixed(1)
    ];

    // 通行能力限制（各相位通行量 * 3600/C）
    const capacityData = [
    (r.phase_volumes.A * 3600 / AppState.params.C).toFixed(0),
    (r.phase_volumes.B * 3600 / AppState.params.C).toFixed(0),
    (r.phase_volumes.C * 3600 / AppState.params.C).toFixed(0),
    (r.phase_volumes.D * 3600 / AppState.params.C).toFixed(0)
    ];

    // 瓶颈贡献度（各相位通行量占总通行量比例）
    const contributionData = [
    (r.phase_volumes.A / totalVol * 100).toFixed(1),
    (r.phase_volumes.B / totalVol * 100).toFixed(1),
    (r.phase_volumes.C / totalVol * 100).toFixed(1),
    (r.phase_volumes.D / totalVol * 100).toFixed(1)
    ];

    phaseBarChart.setOption({
    tooltip: {
    trigger: 'axis',
    axisPointer: { type: 'shadow' }
    },
    legend: {
    data: ['堵塞概率(%)', '通行能力限制(veh/h)', '瓶颈贡献度(%)'],
    bottom: 0,
    textStyle: { fontSize: 10 }
    },
    grid: {
    left: '3%',
    right: '4%',
    bottom: '15%',
    top: '10%',
    containLabel: true
    },
    xAxis: {
    type: 'category',
    data: ['相位A', '相位B', '相位C', '相位D'],
    axisLabel: { color: '#64748b', fontSize: 11 }
    },
    yAxis: {
    type: 'value',
    name: '数值',
    nameTextStyle: { color: '#64748b', fontSize: 11 },
    axisLabel: { color: '#64748b', fontSize: 10 },
    splitLine: { lineStyle: { color: '#e2e8f0', type: 'dashed' } }
    },
    series: [
    {
    name: '堵塞概率(%)',
    type: 'bar',
    data: blockageData,
    itemStyle: { color: '#ef4444' },
    barWidth: '25%',
    label: {
    show: true,
    position: 'top',
    formatter: '{c}%',
    fontSize: 9,
    color: '#ef4444'
    }
    },
    {
    name: '通行能力限制(veh/h)',
    type: 'bar',
    data: capacityData,
    itemStyle: { color: '#3b82f6' },
    barWidth: '25%',
    label: {
    show: true,
    position: 'top',
    formatter: '{c}',
    fontSize: 9,
    color: '#3b82f6'
    }
    },
    {
    name: '瓶颈贡献度(%)',
    type: 'bar',
    data: contributionData,
    itemStyle: { color: '#10b981' },
    barWidth: '25%',
    label: {
    show: true,
    position: 'top',
    formatter: '{c}%',
    fontSize: 9,
    color: '#10b981'
    }
    }
    ]
    });
    }

    // 监听窗口大小变化
    window.removeEventListener('resize', handleResize);
    window.addEventListener('resize', handleResize);
    }

    function handleResize() {
    if (radarChart) radarChart.resize();
    if (barChart) barChart.resize();
    if (phaseBarChart) phaseBarChart.resize();
    if (sensitivityChart) sensitivityChart.resize();
    }

    // 敏感度分析
    let sensitivityChart = null;
    let currentSensitivityType = 1;

    function generateSensitivityData(type, xRange, yRange) {
    const baseParams = {...AppState.params};
    const gridSize = 20;
    const data = [];

    if (type === 1) {
    for (let i = 0; i < gridSize; i++) {
    for (let j = 0; j < gridSize; j++) {
    const p_s = xRange[0] + (j / (gridSize - 1)) * (xRange[1] - xRange[0]);
    const n = Math.round(yRange[0] + (i / (gridSize - 1)) * (yRange[1] - yRange[0]));
    const result = MathEngine.calculateCapacity(
    n, baseParams.C, baseParams.r_total_vph, p_s, 10,
    baseParams.tau, baseParams.t_f, baseParams.s_r_vph, baseParams.s_s_vph,
    baseParams.t_a, baseParams.t_b, baseParams.t_c
    );
    data.push([p_s, n, result.capacity]);
    }
    }
    return { data, xName: '直行车比例', yName: '车道容量', zName: '通行能力' };
    } else if (type === 2) {
    for (let i = 0; i < gridSize; i++) {
    for (let j = 0; j < gridSize; j++) {
    const p_s = xRange[0] + (j / (gridSize - 1)) * (xRange[1] - xRange[0]);
    const lambda_p = yRange[0] + (i / (gridSize - 1)) * (yRange[1] - yRange[0]);
    const result = MathEngine.calculateCapacity(
    5, baseParams.C, baseParams.r_total_vph, p_s, lambda_p,
    baseParams.tau, baseParams.t_f, baseParams.s_r_vph, baseParams.s_s_vph,
    baseParams.t_a, baseParams.t_b, baseParams.t_c
    );
    data.push([p_s, lambda_p, result.capacity]);
    }
    }
    return { data, xName: '直行车比例', yName: '行人到达率', zName: '通行能力' };
    } else {
    for (let i = 0; i < gridSize; i++) {
    for (let j = 0; j < gridSize; j++) {
    const n = Math.round(xRange[0] + (j / (gridSize - 1)) * (xRange[1] - xRange[0]));
    const lambda_p = yRange[0] + (i / (gridSize - 1)) * (yRange[1] - yRange[0]);
    const result = MathEngine.calculateCapacity(
    n, baseParams.C, baseParams.r_total_vph, 0.7, lambda_p,
    baseParams.tau, baseParams.t_f, baseParams.s_r_vph, baseParams.s_s_vph,
    baseParams.t_a, baseParams.t_b, baseParams.t_c
    );
    data.push([n, lambda_p, result.capacity]);
    }
    }
    return { data, xName: '车道容量', yName: '行人到达率', zName: '通行能力' };
    }
    }

    function switchSensitivityChart(type) {
    currentSensitivityType = type;
    [1, 2, 3].forEach(t => {
    const btn = document.getElementById(`btn-sens-${t}`);
    if (t === type) {
    btn.classList.remove('bg-slate-200', 'text-slate-700');
    btn.classList.add('bg-blue-600', 'text-white');
    } else {
    btn.classList.remove('bg-blue-600', 'text-white');
    btn.classList.add('bg-slate-200', 'text-slate-700');
    }
    });
    updateSensitivityInputs(type);

    const defaultRanges = {
    1: { x: [0.01, 0.99], y: [3, 15] },
    2: { x: [0.01, 0.99], y: [0, 40] },
    3: { x: [3, 15], y: [0, 40] }
    };
    const ranges = defaultRanges[type];
    const chartData = generateSensitivityData(type, ranges.x, ranges.y);
    renderSensitivityChart(chartData);
    }

    function updateSensitivityInputs(type) {
    const container = document.getElementById('sensitivity-inputs');
    if (!container) return;
    const configs = {
    1: [
    { id: 'sens-x', label: '直行车比例 (p_s)', min: 0, max: 1, step: 0.01, value: 0.5 },
    { id: 'sens-y', label: '车道容量 (n)', min: 3, max: 20, step: 1, value: 8 }
    ],
    2: [
    { id: 'sens-x', label: '直行车比例 (p_s)', min: 0, max: 1, step: 0.01, value: 0.5 },
    { id: 'sens-y', label: '行人到达率 (λ_p)', min: 0, max: 60, step: 1, value: 20 }
    ],
    3: [
    { id: 'sens-x', label: '车道容量 (n)', min: 3, max: 20, step: 1, value: 8 },
    { id: 'sens-y', label: '行人到达率 (λ_p)', min: 0, max: 60, step: 1, value: 20 }
    ]
    };
    const config = configs[type];
    container.innerHTML = config.map(c => `
    <div>
    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">${c.label}</label>
    <div class="flex items-center gap-3">
    <input type="range" id="${c.id}-range" min="${c.min}" max="${c.max}" step="${c.step}" value="${c.value}"
    class="flex-1 accent-blue-600"
    oninput="document.getElementById('${c.id}-num').value = this.value">
    <input type="number" id="${c.id}-num" min="${c.min}" max="${c.max}" step="${c.step}" value="${c.value}"
    class="w-20 px-2 py-1 border border-slate-200 rounded text-sm font-mono"
    oninput="document.getElementById('${c.id}-range').value = this.value">
    </div>
    </div>
    `).join('');

    container.innerHTML += `
    <div class="pt-4 border-t border-slate-200 mt-4">
    <p class="text-xs font-bold text-slate-500 uppercase mb-2">图表显示范围设置</p>
    <div class="grid grid-cols-2 gap-3">
    <div>
    <label class="text-[10px] text-slate-400">X轴最小值</label>
    <input type="number" id="sens-x-min" class="w-full px-2 py-1 border border-slate-200 rounded text-xs" value="${config[0].min}">
    </div>
    <div>
    <label class="text-[10px] text-slate-400">X轴最大值</label>
    <input type="number" id="sens-x-max" class="w-full px-2 py-1 border border-slate-200 rounded text-xs" value="${config[0].max}">
    </div>
    <div>
    <label class="text-[10px] text-slate-400">Y轴最小值</label>
    <input type="number" id="sens-y-min" class="w-full px-2 py-1 border border-slate-200 rounded text-xs" value="${config[1].min}">
    </div>
    <div>
    <label class="text-[10px] text-slate-400">Y轴最大值</label>
    <input type="number" id="sens-y-max" class="w-full px-2 py-1 border border-slate-200 rounded text-xs" value="${config[1].max}">
    </div>
    </div>
    <button onclick="updateSensitivityRange()" class="w-full mt-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded text-xs font-medium transition-colors">
    应用范围并刷新图表
    </button>
    </div>
    `;
    }

    function updateSensitivityRange() {
    const xMin = parseFloat(document.getElementById('sens-x-min').value) || 0;
    const xMax = parseFloat(document.getElementById('sens-x-max').value) || 1;
    const yMin = parseFloat(document.getElementById('sens-y-min').value) || 0;
    const yMax = parseFloat(document.getElementById('sens-y-max').value) || 100;

    const chartData = generateSensitivityData(currentSensitivityType, [xMin, xMax], [yMin, yMax]);
    renderSensitivityChart(chartData);
    showToast('图表范围已更新', 1500);
    }

    function calculateSensitivityPoint() {
    const x = parseFloat(document.getElementById('sens-x-num').value);
    const y = parseFloat(document.getElementById('sens-y-num').value);

    if (isNaN(x) || isNaN(y)) {
    showToast('请输入有效的数值', 2000);
    return;
    }

    const baseParams = AppState.params;
    let result;

    if (currentSensitivityType === 1) {
    result = MathEngine.calculateCapacity(
    Math.round(y), baseParams.C, baseParams.r_total_vph, x, 10,
    baseParams.tau, baseParams.t_f, baseParams.s_r_vph, baseParams.s_s_vph,
    baseParams.t_a, baseParams.t_b, baseParams.t_c
    );
    } else if (currentSensitivityType === 2) {
    result = MathEngine.calculateCapacity(
    5, baseParams.C, baseParams.r_total_vph, x, y,
    baseParams.tau, baseParams.t_f, baseParams.s_r_vph, baseParams.s_s_vph,
    baseParams.t_a, baseParams.t_b, baseParams.t_c
    );
    } else {
    result = MathEngine.calculateCapacity(
    Math.round(x), baseParams.C, baseParams.r_total_vph, 0.7, y,
    baseParams.tau, baseParams.t_f, baseParams.s_r_vph, baseParams.s_s_vph,
    baseParams.t_a, baseParams.t_b, baseParams.t_c
    );
    }

    document.getElementById('point-x').textContent = x.toFixed(2);
    document.getElementById('point-y').textContent = y.toFixed(2);
    document.getElementById('point-z').textContent = result.capacity.toFixed(1) + ' veh/h';

    const typeNames = { 1: '直行车比例-车道容量', 2: '直行车比例-行人到达率', 3: '车道容量-行人到达率' };
    document.getElementById('point-desc').textContent =
    `当前配置：${typeNames[currentSensitivityType]}，通行能力为 ${result.capacity.toFixed(1)} veh/h`;

    if (sensitivityChart) {
    const option = sensitivityChart.getOption();
    if (!option.series[1]) {
    option.series.push({
    type: 'scatter3D',
    symbolSize: 15,
    itemStyle: { color: '#ef4444', borderColor: '#fff', borderWidth: 2 },
    data: [[x, y, result.capacity]],
    label: { show: true, formatter: '{c}', fontSize: 12, color: '#ef4444' }
    });
    } else {
    option.series[1].data.push([x, y, result.capacity]);
    }
    sensitivityChart.setOption(option);
    }
    showToast('计算完成，已在图上标记', 2000);
    }

    function renderSensitivityChart(chartData) {
    if (sensitivityChart) {
    sensitivityChart.dispose();
    }
    const chartDom = document.getElementById('sensitivity-3d-chart');
    if (!chartDom) return;

    chartDom.style.width = '100%';
    chartDom.style.height = '600px';

    sensitivityChart = echarts.init(chartDom);
    const option = {
    tooltip: {},
    visualMap: {
    show: true,
    dimension: 2,
    min: 0,
    max: 800,
    inRange: {
    color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
    },
    calculable: true,
    orient: 'vertical',
    right: 10,
    top: 'center'
    },
    xAxis3D: {
    type: 'value',
    name: chartData.xName,
    nameTextStyle: { fontSize: 12 }
    },
    yAxis3D: {
    type: 'value',
    name: chartData.yName,
    nameTextStyle: { fontSize: 12 }
    },
    zAxis3D: {
    type: 'value',
    name: chartData.zName,
    nameTextStyle: { fontSize: 12 }
    },
    grid3D: {
    boxWidth: 200,
    boxDepth: 80,
    viewControl: {
    autoRotate: true,
    autoRotateSpeed: 5,
    beta: 40
    },
    light: {
    main: { intensity: 1.2, shadow: true },
    ambient: { intensity: 0.3 }
    }
    },
    series: [{
    type: 'surface',
    wireframe: { show: false },
    shading: 'color',
    data: chartData.data
    }]
    };
    sensitivityChart.setOption(option);
    }

    // 导出报告功能
    function exportReport() {
    if (!AppState.results) {
    showToast('请先执行计算', 2000);
    return;
    }
    const r = AppState.results;
    const p = AppState.params;

    const reportData = {
    inputParams: {
    "信号周期总时长(C,秒)": p.C,
    "相位A结束时刻(t_a,秒)": p.t_a,
    "相位B结束时刻(t_b,秒)": p.t_b,
    "相位C结束时刻(t_c,秒)": p.t_c,
    "总车辆到达率(r,辆/小时)": p.r_total_vph,
    "直行车比例(P_t)": p.p_s,
    "右转口袋车道容量(n,辆)": p.n,
    "右转饱和流率(S_n,辆/小时)": p.s_r_vph,
    "直行车饱和流率(S_ns,辆/小时)": p.s_s_vph,
    "行人到达率(λ_p,人/分钟)": p.lambda_p_ppm,
    "行人过街时间(δ,秒)": p.tau,
    "车辆跟驰时间(t_f,秒)": p.t_f
    },
    middleCalculations: {
    "直行车到达率(r_s,辆/秒)": (p.r_total_vph / 3600 * p.p_s).toFixed(4),
    "行人影响通行能力(λ_c,辆/小时)": r.C_ped.toFixed(1),
    "伽马分布形状参数(k)": p.n + 1,
    "相位A期望通行量(E[V0],辆)": r.E_CA.toFixed(4),
    "情况a期望通行量(E_a,辆)": r.phase_volumes.A.toFixed(4),
    "情况b期望通行量(E_b,辆)": r.phase_volumes.B.toFixed(4),
    "情况c期望通行量(E_c,辆)": r.phase_volumes.C.toFixed(4),
    "情况d期望通行量(E_d,辆)": r.phase_volumes.D.toFixed(4),
    "单周期总通行量(V_total,辆)": r.E_total.toFixed(4)
    },
    blockageProbabilities: {
    "情况a（相位B堵塞）": (r.phase_probs.A * 100).toFixed(2) + '%',
    "情况b（相位C堵塞）": (r.phase_probs.B * 100).toFixed(2) + '%',
    "情况c（相位D堵塞）": (r.phase_probs.C * 100).toFixed(2) + '%',
    "情况d（无堵塞）": (r.phase_probs.D * 100).toFixed(2) + '%'
    },
    finalResults: {
    "右转车道总通行能力(E_total,辆/小时)": r.capacity.toFixed(1),
    "行人影响下的通行能力(λ_c,辆/小时)": r.C_ped.toFixed(1),
    "单周期总通行量(V_total,辆/周期)": r.E_total.toFixed(4),
    "周期初始堵塞概率": (r.P_block_prev * 100).toFixed(1) + '%'
    }
    };

    let csvContent = "路口通行能力计算报告\n\n";
    csvContent += "生成时间," + new Date().toLocaleString('zh-CN') + "\n\n";
    csvContent += "【输入参数】\n";
    for (const [key, value] of Object.entries(reportData.inputParams)) {
    csvContent += `${key},${value}\n`;
    }
    csvContent += "\n【中间计算结果】\n";
    for (const [key, value] of Object.entries(reportData.middleCalculations)) {
    csvContent += `${key},${value}\n`;
    }
    csvContent += "\n【堵塞概率分析】\n";
    for (const [key, value] of Object.entries(reportData.blockageProbabilities)) {
    csvContent += `${key},${value}\n`;
    }
    csvContent += "\n【最终结果】\n";
    for (const [key, value] of Object.entries(reportData.finalResults)) {
    csvContent += `${key},${value}\n`;
    }

    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `路口通行能力报告_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast('报告已导出为CSV格式', 2000);
    }

    // 历史对比功能
    function showHistoryComparison() {
    if (AppState.projects.length < 2) {
    showToast('需要至少2个项目才能进行对比', 2000);
    return;
    }
    const completedProjects = AppState.projects.filter(p => p.capacity && p.status === 'completed');
    if (completedProjects.length < 2) {
    showToast('需要至少2个已完成计算的项目', 2000);
    return;
    }

    let comparisonHTML = `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-2xl p-8 w-[800px] max-w-[90%] max-h-[80vh] overflow-y-auto shadow-2xl">
    <div class="flex items-center justify-between mb-6">
    <h3 class="text-xl font-bold text-slate-800">项目历史对比</h3>
    <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600">
    <span class="iconify" data-icon="mdi:close" data-width="24"></span>
    </button>
    </div>
    <table class="w-full text-left border-collapse">
    <thead>
    <tr class="border-b border-slate-200">
    <th class="py-3 px-4 text-sm font-bold text-slate-700">项目名称</th>
    <th class="py-3 px-4 text-sm font-bold text-slate-700">路口类型</th>
    <th class="py-3 px-4 text-sm font-bold text-slate-700 text-right">通行能力</th>
    <th class="py-3 px-4 text-sm font-bold text-slate-700 text-right">车道容量</th>
    <th class="py-3 px-4 text-sm font-bold text-slate-700 text-right">直行车比例</th>
    <th class="py-3 px-4 text-sm font-bold text-slate-700">修改时间</th>
    </tr>
    </thead>
    <tbody>
    `;
    completedProjects.forEach(project => {
    comparisonHTML += `
    <tr class="border-b border-slate-100 hover:bg-slate-50">
    <td class="py-3 px-4 text-sm text-slate-800 font-medium">${project.name}</td>
    <td class="py-3 px-4 text-sm text-slate-600">${project.type}</td>
    <td class="py-3 px-4 text-sm text-blue-600 font-bold text-right">${project.capacity} veh/h</td>
    <td class="py-3 px-4 text-sm text-slate-600 text-right">${project.params ? project.params.n : '-'}</td>
    <td class="py-3 px-4 text-sm text-slate-600 text-right">${project.params ? (project.params.p_s * 100).toFixed(0) + '%' : '-'}</td>
    <td class="py-3 px-4 text-sm text-slate-500">${project.lastModified}</td>
    </tr>
    `;
    });
    comparisonHTML += `
    </tbody>
    </table>
    <div class="mt-6 pt-6 border-t border-slate-200">
    <div class="grid grid-cols-3 gap-4 text-center">
    <div class="bg-blue-50 p-4 rounded-lg">
    <p class="text-xs text-slate-500 mb-1">最高通行能力</p>
    <p class="text-lg font-bold text-blue-600">${Math.max(...completedProjects.map(p => p.capacity))} veh/h</p>
    </div>
    <div class="bg-green-50 p-4 rounded-lg">
    <p class="text-xs text-slate-500 mb-1">平均通行能力</p>
    <p class="text-lg font-bold text-green-600">${Math.round(completedProjects.reduce((sum, p) => sum + p.capacity, 0) / completedProjects.length)} veh/h</p>
    </div>
    <div class="bg-amber-50 p-4 rounded-lg">
    <p class="text-xs text-slate-500 mb-1">最低通行能力</p>
    <p class="text-lg font-bold text-amber-600">${Math.min(...completedProjects.map(p => p.capacity))} veh/h</p>
    </div>
    </div>
    </div>
    </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', comparisonHTML);
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const dateStr = now.getFullYear() + '年' +
    String(now.getMonth() + 1).padStart(2, '0') + '月' +
    String(now.getDate()).padStart(2, '0') + '日';
    document.getElementById('current-date').textContent = dateStr;

    initEventListeners();
    AppState.calculate();
    AppState.updateUI();
    });
</script>
</body>

</html>
